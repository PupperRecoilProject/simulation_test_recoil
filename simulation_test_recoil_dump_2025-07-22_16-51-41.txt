# å°ˆæ¡ˆç¨‹å¼ç¢¼å½™æ•´: c:\git_project\simulation_test_recoil
================================================================================

#------------------------------------------------------------------------------#
#                              å°ˆæ¡ˆç›®éŒ„çµæ§‹                              #
#------------------------------------------------------------------------------#

simulation_test_recoil/
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ mesh/
â”‚   â”‚   â”œâ”€â”€ Hip_L.stl
â”‚   â”‚   â”œâ”€â”€ Hip_R.stl
â”‚   â”‚   â”œâ”€â”€ Lower_Leg_L.stl
â”‚   â”‚   â”œâ”€â”€ Lower_Leg_R.stl
â”‚   â”‚   â”œâ”€â”€ Upper_Leg_L.stl
â”‚   â”‚   â”œâ”€â”€ Upper_Leg_R.stl
â”‚   â”‚   â”œâ”€â”€ body.stl
â”‚   â”‚   â”œâ”€â”€ hfield.png
â”‚   â”‚   â””â”€â”€ rocky_texture.png
â”‚   â”œâ”€â”€ pupper.xml
â”‚   â”œâ”€â”€ pupper_mjx.xml
â”‚   â”œâ”€â”€ pupper_mjx_1.xml
â”‚   â”œâ”€â”€ scene.xml
â”‚   â”œâ”€â”€ scene_hfield_mjx.xml
â”‚   â”œâ”€â”€ scene_mjx.xml
â”‚   â”œâ”€â”€ scene_mjx_feetonly_bowl.xml
â”‚   â”œâ”€â”€ scene_mjx_feetonly_flat_terrain.xml
â”‚   â”œâ”€â”€ scene_mjx_feetonly_rough_terrain.xml
â”‚   â”œâ”€â”€ scene_mjx_feetonly_stairs.xml
â”‚   â”œâ”€â”€ scene_mjx_flat_terrain.xml
â”‚   â””â”€â”€ scene_mjx_fullcollisions_flat_terrain.xml
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ pupper_ppo_policy_200540160_tf_converted.onnx
â”‚   â”œâ”€â”€ pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.onnx
â”‚   â””â”€â”€ pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.optimized.ort
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ dump_project.py
â”‚   â”œâ”€â”€ test_joystick.py
â”‚   â””â”€â”€ verify_model_mode.py
â”œâ”€â”€ config.py
â”œâ”€â”€ config.yaml
â”œâ”€â”€ floating_controller.py
â”œâ”€â”€ hardware_controller.py
â”œâ”€â”€ keyboard_input_handler.py
â”œâ”€â”€ main.py
â”œâ”€â”€ observation.py
â”œâ”€â”€ policy.py
â”œâ”€â”€ readme.md
â”œâ”€â”€ rendering.py
â”œâ”€â”€ serial_communicator.py
â”œâ”€â”€ simulation.py
â”œâ”€â”€ state.py
â”œâ”€â”€ terrain_manager.py
â”œâ”€â”€ xbox_controller.py
â””â”€â”€ xbox_input_handler.py


#------------------------------------------------------------------------------#
#                               å„æª”æ¡ˆå…§å®¹                                #
#------------------------------------------------------------------------------#

================================================================================
--- START OF FILE: config.py ---
--------------------------------

# config.py
import yaml
from dataclasses import dataclass, field
from typing import Dict, List, Any

@dataclass
class TuningParamsConfig:
    """å¾è¨­å®šæª”è¼‰å…¥çš„åˆå§‹èª¿æ ¡åƒæ•¸è³‡æ–™é¡åˆ¥ã€‚"""
    kp: float
    kd: float
    action_scale: float
    bias: float

@dataclass
class FloatingControllerConfig:
    """æ‡¸æµ®æ§åˆ¶å™¨çš„è¨­å®šã€‚"""
    target_height: float
    kp_vertical: float
    kd_vertical: float
    kp_attitude: float
    kd_attitude: float

@dataclass
class AppConfig:
    """å„²å­˜æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼è¨­å®šçš„è³‡æ–™é¡åˆ¥ã€‚"""
    mujoco_model_file: str
    onnx_model_path: str
    num_motors: int
    physics_timestep: float
    control_freq: float
    control_dt: float
    warmup_duration: float
    command_scaling_factors: List[float]
    
    keyboard_velocity_adjust_step: float
    gamepad_sensitivity: Dict[str, float]
    param_adjust_steps: Dict[str, float]

    initial_tuning_params: TuningParamsConfig
    observation_recipes: Dict[int, List[str]]
    floating_controller: FloatingControllerConfig

def load_config(path: str = "config.yaml") -> AppConfig:
    """
    å¾ YAML æª”æ¡ˆè¼‰å…¥è¨­å®šä¸¦å›å‚³ä¸€å€‹ AppConfig ç‰©ä»¶ã€‚
    """
    try:
        with open(path, 'r', encoding='utf-8') as f:
            config_data = yaml.safe_load(f)
    except FileNotFoundError:
        raise FileNotFoundError(f"è¨­å®šæª” '{path}' ä¸å­˜åœ¨ã€‚è«‹ç¢ºä¿æª”æ¡ˆè·¯å¾‘æ­£ç¢ºã€‚")
    except Exception as e:
        raise IOError(f"è®€å–æˆ–è§£æè¨­å®šæª” '{path}' æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    tuning_params = TuningParamsConfig(**config_data['initial_tuning_params'])
    floating_config = FloatingControllerConfig(**config_data['floating_controller'])
    
    config_obj = AppConfig(
        mujoco_model_file=config_data['mujoco_model_file'],
        onnx_model_path=config_data['onnx_model_path'],
        num_motors=config_data['num_motors'],
        physics_timestep=config_data['physics_timestep'],
        control_freq=config_data['control_freq'],
        control_dt=1.0 / config_data['control_freq'],
        warmup_duration=config_data['warmup_duration'],
        command_scaling_factors=config_data['command_scaling_factors'],
        
        keyboard_velocity_adjust_step=config_data['keyboard_velocity_adjust_step'],
        gamepad_sensitivity=config_data['gamepad_sensitivity'],
        param_adjust_steps=config_data['param_adjust_steps'],
        
        initial_tuning_params=tuning_params,
        observation_recipes=config_data['observation_recipes'],
        floating_controller=floating_config
    )
    
    print("âœ… è¨­å®šæª”è¼‰å…¥æˆåŠŸ (åŒ…å«æ‡¸æµ®æ§åˆ¶å™¨è¨­å®š)ã€‚")
    return config_obj

--------------------------------
---  END OF FILE: config.py  ---
================================================================================

================================================================================
--- START OF FILE: config.yaml ---
----------------------------------

# ==================================
# === æ¨¡æ“¬èˆ‡æ¨¡å‹è¨­å®š (Simulation & Model Settings)
# ==================================
# æª”æ¡ˆè·¯å¾‘ (File Paths)
mujoco_model_file: "assets/scene_mjx.xml"
onnx_model_path: "models/pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.onnx"

# æ ¸å¿ƒåƒæ•¸ (Core Parameters)
num_motors: 12
physics_timestep: 0.004 # <-- å»ºè­°ä¿®æ”¹ï¼šæé«˜æ¨¡æ“¬ç²¾åº¦ä»¥å¢å¼·ç©©å®šæ€§
control_freq: 50.0
warmup_duration: 0.0

# ONNX æ¨¡å‹å‘½ä»¤è¼¸å…¥ç¸®æ”¾å› å­
# é †åº: [vy ç¸®æ”¾, vx ç¸®æ”¾, wz ç¸®æ”¾]
command_scaling_factors: [1.0, 1.0, 1.0] 

# ==================================
# === è¼¸å…¥æ§åˆ¶è¨­å®š (Input Control Settings)
# ==================================
keyboard_velocity_adjust_step: 0.1 # m/s or rad/s per key press

gamepad_sensitivity:
  vx: 1.0   # å‰å¾Œé€Ÿåº¦éˆæ•åº¦ (å·¦æ–æ¡¿ Y)
  vy: 1.0   # å·¦å³é€Ÿåº¦éˆæ•åº¦ (å·¦æ–æ¡¿ X)
  wz: -1.5  # è½‰å‘è§’é€Ÿåº¦éˆæ•åº¦ (å³æ–æ¡¿ X), è² å€¼è¡¨ç¤ºå³æ¨å³è½‰

param_adjust_steps:
  kp: 0.5
  kd: 0.05
  action_scale: 0.05
  bias: 5

# ==================================
# === åˆå§‹èª¿æ ¡åƒæ•¸ (Initial Tuning Parameters)
# ==================================
initial_tuning_params:
  kp: 4.0
  kd: 0.40
  action_scale: 0.5
  bias: -0.0

# ==================================
# === è§€å¯Ÿé…æ–¹ (Observation Recipes)
# ==================================
observation_recipes:
  31:
    - 'z_angular_velocity'
    - 'gravity_vector'
    - 'commands'
    - 'joint_positions'
    - 'last_action'
  48: # <-- ä¿®æ”¹é€™å€‹ 48 ç¶­çš„é †åº
    - 'linear_velocity'
    - 'angular_velocity'
    - 'gravity_vector'
    - 'joint_positions'
    - 'joint_velocities'
    - 'last_action'
    - 'commands' # <-- å°‡ commands ç§»å‹•åˆ°æœ€å¾Œ

# ================================================================= #
# === æ‡¸æµ®æ§åˆ¶å™¨è¨­å®š (Floating Controller Settings) - ç²¾ç´°èª¿æ ¡ç‰ˆ ===
# ================================================================= #
floating_controller:
  target_height: 0.50     # æ‡¸æµ®çš„ç›®æ¨™é«˜åº¦ (ç±³)
  kp_vertical: 80.0       # å‚ç›´ P (å†æ¬¡é™ä½ä»¥æ±‚å¹³æ»‘)
  kd_vertical: 18.0       # å‚ç›´ D (ä¿æŒèˆ‡Kpçš„é—œä¿‚)
  kp_attitude: 20.0       # å§¿æ…‹ P (å†æ¬¡é™ä½)
  kd_attitude: 4.0        # å§¿æ…‹ D (ç›¸æ‡‰èª¿æ•´)

----------------------------------
---  END OF FILE: config.yaml  ---
================================================================================

================================================================================
--- START OF FILE: floating_controller.py ---
---------------------------------------------

# floating_controller.py
import mujoco
import numpy as np
from config import AppConfig

class FloatingController:
    """
    é€éå•Ÿç”¨/ç¦ç”¨ weld ç´„æŸå’Œè¨­å®š mocap body çš„ä½ç½®ï¼Œ
    ä¾†å°‡æ©Ÿå™¨äººä¸»å¹¹å›ºå®šåœ¨ç©ºä¸­ã€‚
    """
    def __init__(self, config: AppConfig, model, data):
        """
        åˆå§‹åŒ–æ‡¸æµ®æ§åˆ¶å™¨ï¼Œä¸¦ç²å–å¿…è¦çš„ MuJoCo ID å’Œç´¢å¼•ã€‚
        """
        self.config = config.floating_controller
        self.model = model
        self.data = data
        self.is_functional = False
        
        try:
            anchor_body_id = mujoco.mj_name2id(model, mujoco.mjtObj.mjOBJ_BODY, 'anchor')
            if anchor_body_id == -1: raise ValueError("åœ¨ XML ä¸­æ‰¾ä¸åˆ°åç‚º 'anchor' çš„ bodyã€‚")
            
            self.mocap_index = model.body_mocapid[anchor_body_id]
            if self.mocap_index == -1: raise ValueError("'anchor' body ä¸æ˜¯ä¸€å€‹ mocap bodyã€‚")

            self.weld_id = mujoco.mj_name2id(model, mujoco.mjtObj.mjOBJ_EQUALITY, 'torso_anchor_weld')
            if self.weld_id == -1: raise ValueError("åœ¨ XML ä¸­æ‰¾ä¸åˆ°åç‚º 'torso_anchor_weld' çš„ weld ç´„æŸã€‚")

            self.is_functional = True
            print(f"âœ… å›ºå®šå¼æ‡¸æµ®æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆã€‚Mocap Index: {self.mocap_index}")
        except ValueError as e:
            print(f"âŒ æ‡¸æµ®æ§åˆ¶å™¨åˆå§‹åŒ–éŒ¯èª¤: {e}")
            print("     è«‹ç¢ºä¿ scene_mjx.xml æª”æ¡ˆå·²æ­£ç¢ºå®šç¾© 'anchor' body å’Œ 'torso_anchor_weld' ç´„æŸã€‚æ‡¸æµ®åŠŸèƒ½å°‡è¢«ç¦ç”¨ã€‚")

    def enable(self, current_pos: np.ndarray):
        """å•Ÿç”¨æ‡¸æµ®æ¨¡å¼ã€‚"""
        if not self.is_functional: return
        
        target_pos = np.array([current_pos[0], current_pos[1], self.config.target_height])
        self.data.mocap_pos[self.mocap_index] = target_pos
        self.data.mocap_quat[self.mocap_index] = np.array([1., 0, 0, 0]) # ä¿æŒæ°´å¹³å§¿æ…‹
        self.data.eq_active[self.weld_id] = 1
        print("ğŸš€ å·²å•Ÿç”¨å›ºå®šæ‡¸æµ®æ¨¡å¼ã€‚")

    def disable(self):
        """ç¦ç”¨æ‡¸æµ®æ¨¡å¼ã€‚"""
        if not self.is_functional: return
        self.data.eq_active[self.weld_id] = 0
        print("ğŸ¾ å·²ç¦ç”¨å›ºå®šæ‡¸æµ®æ¨¡å¼ã€‚")

---------------------------------------------
---  END OF FILE: floating_controller.py  ---
================================================================================

================================================================================
--- START OF FILE: hardware_controller.py ---
---------------------------------------------

# hardware_controller.py
import serial
import serial.tools.list_ports
import threading
import time
import re
import numpy as np
from scipy.spatial.transform import Rotation
from typing import TYPE_CHECKING

# ç‚ºäº†å‹åˆ¥æç¤ºï¼Œé¿å…è¿´åœˆåŒ¯å…¥
if TYPE_CHECKING:
    from config import AppConfig
    from policy import ONNXPolicy
    from state import SimulationState

class RobotStateHardware:
    """ä¸€å€‹å°ˆé–€ç”¨ä¾†å„²å­˜å¾å¯¦é«”æ©Ÿå™¨äººç²å–çš„å³æ™‚ç‹€æ…‹çš„æ•¸æ“šé¡ã€‚"""
    def __init__(self):
        self.imu_gyro_radps = np.zeros(3, dtype=np.float32)
        self.imu_acc_g = np.zeros(3, dtype=np.float32)
        self.joint_positions_rad = np.zeros(12, dtype=np.float32)
        self.joint_velocities_radps = np.zeros(12, dtype=np.float32)
        self.lin_vel_local = np.zeros(3, dtype=np.float32)
        self.gravity_vector_local = np.zeros(3, dtype=np.float32)
        self.last_action = np.zeros(12, dtype=np.float32)
        self.command = np.zeros(3, dtype=np.float32)
        self.last_update_time = 0.0

class HardwareController:
    """ç®¡ç†èˆ‡å¯¦é«”ç¡¬é«”(ä¾‹å¦‚Teensy)çš„é€£æ¥å’Œé«˜é »æ§åˆ¶è¿´åœˆã€‚"""
    
    def __init__(self, config: 'AppConfig', policy: 'ONNXPolicy', global_state: 'SimulationState'):
        """åˆå§‹åŒ–ç¡¬é«”æ§åˆ¶å™¨ã€‚"""
        self.config = config
        self.policy = policy
        self.global_state = global_state
        
        self.ser = None
        self.is_running = False
        self.read_thread = None
        self.control_thread = None
        
        self.hw_state = RobotStateHardware()
        self.lock = threading.Lock()
        self.ai_control_enabled = threading.Event()

        # ã€é‡è¦ã€‘: æ©Ÿå™¨äººé‹å‹•å­¸åƒæ•¸
        # é è¨­ç«™å§¿ä¸‹ï¼Œè…³å°–ç›¸å°æ–¼èº«é«”ä¸­å¿ƒçš„åº§æ¨™ (ç±³)
        # æ³¨æ„: é€™å€‹å€¼éœ€è¦æ ¹æ“šæ‚¨çš„å¯¦é«”æ©Ÿå™¨äººç²¾ç¢ºæ¸¬é‡æˆ–å¾ URDF/CAD æ¨¡å‹ä¸­å°å‡º
        # é€™å€‹å€¼æ˜¯æ ¹æ“šæ‚¨å°ˆæ¡ˆä¸­çš„ `pupper.xml` æ¨ç®—çš„ï¼Œæ‚¨å¯èƒ½éœ€è¦å¾®èª¿
        self.foot_positions_in_body = np.array([
            [-0.080, -0.176, -0.2],  # FR (Front Right)
            [ 0.080, -0.176, -0.2],  # FL (Front Left)
            [-0.080,  0.024, -0.2],  # RR (Rear Right)
            [ 0.080,  0.024, -0.2]   # RL (Rear Left)
        ], dtype=np.float32)

        print("âœ… ç¡¬é«”æ§åˆ¶å™¨å·²åˆå§‹åŒ–ã€‚")

    def connect_and_start(self) -> bool:
        """æƒæä¸¦é€£æ¥åˆ°åºåˆ—åŸ ï¼Œå¦‚æœæˆåŠŸï¼Œå‰‡å•Ÿå‹•æ‰€æœ‰èƒŒæ™¯åŸ·è¡Œç·’ã€‚"""
        if self.is_running:
            print("ç¡¬é«”æ§åˆ¶å™¨å·²åœ¨é‹è¡Œä¸­ã€‚")
            return True
            
        print("\n" + "="*20 + " æ­£åœ¨æƒæå¯ç”¨åºåˆ—åŸ  " + "="*20)
        ports = serial.tools.list_ports.comports()
        if not ports:
            print("âŒ éŒ¯èª¤: æœªæ‰¾åˆ°ä»»ä½•åºåˆ—åŸ ã€‚")
            return False
        
        # é€™è£¡æˆ‘å€‘è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹æ‰¾åˆ°çš„åŸ ï¼Œæ‚¨å¯ä»¥æ ¹æ“šéœ€è¦ä¿®æ”¹ç‚ºæ‰‹å‹•é¸æ“‡
        port_name = ports[0].device
        print(f"è‡ªå‹•é¸æ“‡åŸ : {port_name} (æ³¢ç‰¹ç‡: 115200)")

        try:
            self.ser = serial.Serial(port_name, 115200, timeout=1)
            time.sleep(1.0)
            self.ser.flushInput()
            print(f"âœ… æˆåŠŸé€£æ¥åˆ° {port_name}")
            
            self.is_running = True
            self.read_thread = threading.Thread(target=self._read_from_port, daemon=True)
            self.read_thread.start()
            self.control_thread = threading.Thread(target=self._control_loop, daemon=True)
            self.control_thread.start()
            
            print("âœ… ç¡¬é«”æ§åˆ¶åŸ·è¡Œç·’å·²å•Ÿå‹•ã€‚")
            return True
        except serial.SerialException as e:
            print(f"âŒ é€£æ¥å¤±æ•—: {e}")
            self.ser = None
            return False

    def stop(self):
        """å®‰å…¨åœ°åœæ­¢æ‰€æœ‰åŸ·è¡Œç·’å’Œåºåˆ—åŸ é€£æ¥ã€‚"""
        if not self.is_running: return
        
        print("æ­£åœ¨åœæ­¢ç¡¬é«”æ§åˆ¶å™¨...")
        self.is_running = False
        self.disable_ai()
        self.ai_control_enabled.set()
        
        if self.control_thread and self.control_thread.is_alive(): self.control_thread.join(timeout=1)
        if self.read_thread and self.read_thread.is_alive(): self.read_thread.join(timeout=1)
        
        if self.ser and self.ser.is_open:
            self.ser.close()
            print(f"åºåˆ—åŸ  {self.ser.port} å·²é—œé–‰ã€‚")
        
        self.ser = None
        print("ç¡¬é«”æ§åˆ¶å™¨å·²å®Œå…¨åœæ­¢ã€‚")
        
    def enable_ai(self):
        """å•Ÿç”¨ AI æ§åˆ¶ã€‚"""
        if not self.is_running:
            print("ç„¡æ³•å•Ÿç”¨ AIï¼šç¡¬é«”æ§åˆ¶å™¨æœªé‹è¡Œã€‚")
            return
        print("ğŸ¤– AI æ§åˆ¶å·²å•Ÿç”¨ã€‚")
        self.policy.reset()
        self.ai_control_enabled.set()
        self.global_state.hardware_ai_is_active = True

    def disable_ai(self):
        """ç¦ç”¨ AI æ§åˆ¶ã€‚"""
        print("â¸ï¸ AI æ§åˆ¶å·²æš«åœã€‚")
        self.ai_control_enabled.clear()
        self.global_state.hardware_ai_is_active = False
        if self.ser and self.ser.is_open:
            try: self.ser.write(b"stop\n")
            except serial.SerialException as e: print(f"ç™¼é€åœæ­¢æŒ‡ä»¤å¤±æ•—: {e}")

    def parse_teensy_data(self, line: str):
        """ä½¿ç”¨æ­£å‰‡è¡¨é”å¼è§£æä¾†è‡ª Teensy çš„å–®è¡Œå­—ä¸²æ•¸æ“šã€‚"""
        acc_match = re.search(r"IMU Acc\(g\) -> X: ([+-]?[\d.]+)\s+Y: ([+-]?[\d.]+)\s+Z: ([+-]?[\d.]+)", line)
        gyro_match = re.search(r"IMU Gyro\(dps\)-> X: ([+-]?[\d.]+)\s+Y: ([+-]?[\d.]+)\s+Z: ([+-]?[\d.]+)", line)
        motor_match = re.search(r"Motor\s+(\d+)\s*\|\s*Pos:\s+([+-]?[\d.]+)\s*\|\s*Vel:\s+([+-]?[\d.]+)", line)

        with self.lock:
            if acc_match:
                self.hw_state.imu_acc_g = np.array([float(g) for g in acc_match.groups()], dtype=np.float32)
            elif gyro_match:
                dps = np.array([float(g) for g in gyro_match.groups()], dtype=np.float32)
                self.hw_state.imu_gyro_radps = dps * (np.pi / 180.0)
            elif motor_match:
                motor_id = int(motor_match.group(1))
                if 0 <= motor_id < self.config.num_motors:
                    self.hw_state.joint_positions_rad[motor_id] = float(motor_match.group(2))
                    self.hw_state.joint_velocities_radps[motor_id] = float(motor_match.group(3))
            self.hw_state.last_update_time = time.time()

    def estimate_linear_velocity(self):
        """[æ ¸å¿ƒæ¼”ç®—æ³•] æ ¹æ“š IMU å’Œé‹å‹•å­¸æ¨¡å‹ï¼Œä¼°ç®—æ©Ÿèº«çš„ç·šé€Ÿåº¦ã€‚"""
        with self.lock:
            acc_g = self.hw_state.imu_acc_g.copy()
            w_body = self.hw_state.imu_gyro_radps.copy()
        
        body_gravity_vec = acc_g * 9.81
        world_gravity_vec = np.array([0, 0, -9.81])
        
        if np.linalg.norm(body_gravity_vec) < 1e-6: return

        try:
            rot_body_to_world, _ = Rotation.align_vectors(world_gravity_vec.reshape(1, -1), body_gravity_vec.reshape(1, -1))
        except (ValueError, np.linalg.LinAlgError): return

        w_world = rot_body_to_world.apply(w_body)

        foot_velocities_world = []
        for i in range(4):
            r_foot_in_world = rot_body_to_world.apply(self.foot_positions_in_body[i])
            v_foot_world = np.cross(w_world, r_foot_in_world)
            foot_velocities_world.append(np.linalg.norm(v_foot_world))

        stance_foot_idx = np.argmin(foot_velocities_world)
        r_stance_foot_in_world = rot_body_to_world.apply(self.foot_positions_in_body[stance_foot_idx])
        v_body_world_est = -np.cross(w_world, r_stance_foot_in_world)

        with self.lock:
            self.hw_state.gravity_vector_local = body_gravity_vec
            self.hw_state.lin_vel_local = rot_body_to_world.inv().apply(v_body_world_est)

    def construct_observation(self) -> np.ndarray:
        """å»ºç«‹æä¾›çµ¦ ONNX æ¨¡å‹çš„è§€å¯Ÿå‘é‡ã€‚"""
        self.estimate_linear_velocity()
        
        with self.lock:
            self.hw_state.command = self.global_state.command * np.array(self.config.command_scaling_factors)
            
            # æ ¹æ“š config.yaml ä¸­48ç¶­çš„é…æ–¹ä¾†å»ºç«‹è§€å¯Ÿå‘é‡
            obs_list = {
                'linear_velocity': self.hw_state.lin_vel_local,
                'angular_velocity': self.hw_state.imu_gyro_radps,
                'gravity_vector': self.hw_state.gravity_vector_local,
                'joint_positions': self.hw_state.joint_positions_rad,
                'joint_velocities': self.hw_state.joint_velocities_radps,
                'last_action': self.hw_state.last_action,
                'commands': self.hw_state.command,
            }
            # ç¢ºä¿é †åºèˆ‡ config.yaml ä¸­å®šç¾©çš„ä¸€è‡´
            recipe = self.config.observation_recipes.get(48, [])
            final_obs_list = [obs_list[key] for key in recipe if key in obs_list]

            if not final_obs_list:
                print("âš ï¸ è­¦å‘Š: ç„¡æ³•æ ¹æ“šé…æ–¹å»ºç«‹è§€å¯Ÿå‘é‡ã€‚")
                return np.zeros(48)
                
            return np.concatenate(final_obs_list).astype(np.float32)

    def _read_from_port(self):
        """[èƒŒæ™¯åŸ·è¡Œç·’] æŒçºŒå¾åºåˆ—åŸ è®€å–æ•¸æ“šä¸¦èª¿ç”¨è§£æå™¨ã€‚"""
        print("[ç¡¬é«”è®€å–ç·šç¨‹å·²å•Ÿå‹•] ç­‰å¾…ä¾†è‡ª Teensy çš„æ•¸æ“š...")
        while self.is_running:
            if not self.ser or not self.ser.is_open:
                self.stop()
                break
            try:
                line = self.ser.readline().decode('utf-8', errors='ignore').strip()
                if line: self.parse_teensy_data(line)
            except (serial.SerialException, OSError):
                print("âŒ éŒ¯èª¤ï¼šåºåˆ—åŸ æ–·é–‹é€£æ¥æˆ–è®€å–éŒ¯èª¤ã€‚")
                self.stop()
                break
            except Exception as e: print(f"âŒ _read_from_port ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: {e}")
                
    def _control_loop(self):
        """[èƒŒæ™¯åŸ·è¡Œç·’] ä»¥å›ºå®šé »ç‡åŸ·è¡Œ AI æ§åˆ¶ã€‚"""
        print("\n--- ç¡¬é«”æ§åˆ¶ç·šç¨‹å·²å°±ç·’ï¼Œç­‰å¾… AI å•Ÿç”¨ ---")
        # å‡è¨­ç¡¬é«”çš„é è¨­ç«™å§¿èˆ‡æ¨¡æ“¬ä¸­çš„ `default_pose` ç›¸åŒ
        default_pose_hardware = self.global_state.sim.default_pose

        while self.is_running:
            self.ai_control_enabled.wait()
            if not self.is_running: break

            loop_start_time = time.perf_counter()
            
            observation = self.construct_observation()
            
            _, action_raw = self.policy.get_action(observation)
            
            with self.lock:
                self.hw_state.last_action[:] = action_raw
            
            # æ ¹æ“šæ‚¨çš„æ¨¡æ“¬å™¨é‚è¼¯ï¼Œæœ€çµ‚æ§åˆ¶æŒ‡ä»¤æ˜¯ default_pose + scaled_action
            final_command = default_pose_hardware + action_raw * self.global_state.tuning_params.action_scale

            action_str = ' '.join(f"{a:.4f}" for a in final_command)
            command_to_send = f"jpos {action_str}\n"

            if self.ser and self.ser.is_open:
                try: self.ser.write(command_to_send.encode('utf-8'))
                except serial.SerialException: self.stop()
            
            loop_duration = time.perf_counter() - loop_start_time
            sleep_time = (1.0 / self.config.control_freq) - loop_duration
            if sleep_time > 0:
                time.sleep(sleep_time)

---------------------------------------------
---  END OF FILE: hardware_controller.py  ---
================================================================================

================================================================================
--- START OF FILE: keyboard_input_handler.py ---
------------------------------------------------

# keyboard_input_handler.py
import glfw
from state import SimulationState

class KeyboardInputHandler:
    """
    è™•ç†æ‰€æœ‰éµç›¤è¼¸å…¥äº‹ä»¶ï¼Œä¸¦æ ¹æ“šç•¶å‰æ¨¡å¼é€²è¡Œåˆ†æ´¾ã€‚
    """
    # ã€ä¿®æ”¹ã€‘__init__ ä»¥ç§»é™¤ hw_controllerï¼Œå› ç‚ºå¯ä»¥å¾ state ä¸­ç²å–
    def __init__(self, state: SimulationState, serial_comm, xbox_handler, terrain_manager):
        self.state = state
        self.config = state.config
        self.serial_comm = serial_comm
        self.xbox_handler = xbox_handler
        self.terrain_manager = terrain_manager
        self.param_keys = ['kp', 'kd', 'action_scale', 'bias']
        self.num_params = len(self.param_keys)

    def register_callbacks(self, window):
        glfw.set_key_callback(window, self.key_callback)
        glfw.set_char_callback(window, self.char_callback)

    def char_callback(self, window, codepoint):
        if self.state.control_mode == "SERIAL_MODE":
            self.state.serial_command_buffer += chr(codepoint)

    def key_callback(self, window, key, scancode, action, mods):
        # --- 1. åªåœ¨æŒ‰éµæŒ‰ä¸‹æ™‚è§¸ç™¼çš„é€šç”¨åŠŸèƒ½ (æ¨¡å¼åˆ‡æ›ã€é‡ç½®ç­‰) ---
        if action == glfw.PRESS:
            if key == glfw.KEY_SPACE: self.state.single_step_mode = not self.state.single_step_mode; print(f"\n--- SIMULATION {'PAUSED' if self.state.single_step_mode else 'PLAYING'} ---"); return
            if self.state.single_step_mode and key == glfw.KEY_N: self.state.execute_one_step = True; return
            if key == glfw.KEY_ESCAPE: glfw.set_window_should_close(window, 1); return
            if key == glfw.KEY_R: self.state.hard_reset_requested = True; return
            if key == glfw.KEY_X: self.state.soft_reset_requested = True; return
            if key == glfw.KEY_TAB: self.state.display_page = (self.state.display_page + 1) % self.state.num_display_pages; return
            if key == glfw.KEY_M: self.state.toggle_input_mode("GAMEPAD" if self.state.input_mode == "KEYBOARD" else "KEYBOARD"); return
            if key == glfw.KEY_V: 
                self.terrain_manager.cycle_terrain()
                return
            
            # è¨­å‚™æƒæ
            if key == glfw.KEY_U: self.state.serial_is_connected = self.serial_comm.scan_and_connect(); return
            if key == glfw.KEY_J: self.state.gamepad_is_connected = self.xbox_handler.scan_and_connect(); return
            
            # --- æ–°å¢ç¡¬é«”æ¨¡å¼ç›¸é—œæŒ‰éµ ---
            if key == glfw.KEY_H: # 'H' for Hardware
                # åœ¨ "WALKING"(æˆ–ä»»ä½•éç¡¬é«”æ¨¡å¼) å’Œ "HARDWARE_MODE" ä¹‹é–“åˆ‡æ›
                new_mode = "HARDWARE_MODE" if self.state.control_mode != "HARDWARE_MODE" else "WALKING"
                self.state.set_control_mode(new_mode)
                return
            
            if key == glfw.KEY_K: # 'K' for Kill-switch/Activate
                if self.state.control_mode == "HARDWARE_MODE" and self.state.hardware_controller_ref:
                    if self.state.hardware_ai_is_active:
                        self.state.hardware_controller_ref.disable_ai()
                    else:
                        self.state.hardware_controller_ref.enable_ai()
                else:
                    print("è«‹å…ˆæŒ‰ 'H' é€²å…¥ç¡¬é«”æ¨¡å¼ã€‚")
                return


        # --- 2. å¯é‡è¤‡è§¸ç™¼çš„æ¨¡å¼ç‰¹å®šåŠŸèƒ½ ---
        if action in [glfw.PRESS, glfw.REPEAT]:
            if self.state.control_mode == "SERIAL_MODE":
                if key == glfw.KEY_ENTER: self.state.serial_command_to_send = self.state.serial_command_buffer; self.state.serial_command_buffer = ""
                elif key == glfw.KEY_BACKSPACE: self.state.serial_command_buffer = self.state.serial_command_buffer[:-1]
                elif key == glfw.KEY_T and action == glfw.PRESS: self.state.set_control_mode("WALKING")
                return

            if self.state.control_mode == "JOINT_TEST":
                if key == glfw.KEY_LEFT_BRACKET and action == glfw.PRESS: self.state.joint_test_index = (self.state.joint_test_index - 1) % 12
                elif key == glfw.KEY_RIGHT_BRACKET and action == glfw.PRESS: self.state.joint_test_index = (self.state.joint_test_index + 1) % 12
                elif key == glfw.KEY_UP: self.state.joint_test_offsets[self.state.joint_test_index] += 0.1
                elif key == glfw.KEY_DOWN: self.state.joint_test_offsets[self.state.joint_test_index] -= 0.1
                elif key == glfw.KEY_C and action == glfw.PRESS: self.state.joint_test_offsets.fill(0.0)
                elif key == glfw.KEY_G and action == glfw.PRESS: self.state.set_control_mode("WALKING")
                return

            if self.state.control_mode == "MANUAL_CTRL":
                if key == glfw.KEY_F and action == glfw.PRESS:
                    self.state.manual_mode_is_floating = not self.state.manual_mode_is_floating
                    is_floating = self.state.manual_mode_is_floating
                    if is_floating:
                        if self.state.floating_controller_ref: self.state.floating_controller_ref.enable(self.state.latest_pos)
                    else:
                        if self.state.floating_controller_ref: self.state.floating_controller_ref.disable()
                elif key == glfw.KEY_LEFT_BRACKET and action == glfw.PRESS: self.state.manual_ctrl_index = (self.state.manual_ctrl_index - 1) % 12
                elif key == glfw.KEY_RIGHT_BRACKET and action == glfw.PRESS: self.state.manual_ctrl_index = (self.state.manual_ctrl_index + 1) % 12
                elif key == glfw.KEY_UP: self.state.manual_final_ctrl[self.state.manual_ctrl_index] += 0.1
                elif key == glfw.KEY_DOWN: self.state.manual_final_ctrl[self.state.manual_ctrl_index] -= 0.1
                elif key == glfw.KEY_C and action == glfw.PRESS: self.state.manual_final_ctrl.fill(0.0)
                elif key == glfw.KEY_G and action == glfw.PRESS: self.state.set_control_mode("WALKING")
                return

        # --- 3. å¦‚æœä»¥ä¸Šæ¨¡å¼éƒ½ä¸æ˜¯ï¼Œå‰‡åŸ·è¡Œ WALKING/FLOATING æ¨¡å¼çš„é è¨­æŒ‰éµé‚è¼¯ ---
        if action == glfw.PRESS:
            # æ³¨æ„: H éµå·²åœ¨é€šç”¨å€è™•ç†
            if key == glfw.KEY_F: self.state.set_control_mode("FLOATING" if self.state.control_mode == "WALKING" else "WALKING"); return
            if key == glfw.KEY_T: self.state.set_control_mode("SERIAL_MODE"); return
            if key == glfw.KEY_G: self.state.set_control_mode("JOINT_TEST"); return
            if key == glfw.KEY_B: self.state.set_control_mode("MANUAL_CTRL"); return
        
        if self.state.input_mode != "KEYBOARD": return
            
        if action in [glfw.PRESS, glfw.REPEAT]:
            # åƒæ•¸èª¿æ•´
            if key == glfw.KEY_LEFT_BRACKET: self.state.tuning_param_index = (self.state.tuning_param_index - 1) % self.num_params
            elif key == glfw.KEY_RIGHT_BRACKET: self.state.tuning_param_index = (self.state.tuning_param_index + 1) % self.num_params
            elif key == glfw.KEY_UP or key == glfw.KEY_DOWN:
                param_to_adjust = self.param_keys[self.state.tuning_param_index]
                step = self.config.param_adjust_steps.get(param_to_adjust, 0.1)
                current_value = getattr(self.state.tuning_params, param_to_adjust)
                direction = 1 if key == glfw.KEY_UP else -1
                setattr(self.state.tuning_params, param_to_adjust, current_value + step * direction)
                
                self.state.tuning_params.kp = max(0, self.state.tuning_params.kp)
                self.state.tuning_params.kd = max(0, self.state.tuning_params.kd)
                self.state.tuning_params.action_scale = max(0, self.state.tuning_params.action_scale)

            # ç§»å‹•æ§åˆ¶
            step = self.config.keyboard_velocity_adjust_step
            if key == glfw.KEY_C: self.state.clear_command()
            elif key == glfw.KEY_W: self.state.command[1] += step
            elif key == glfw.KEY_S: self.state.command[1] -= step
            elif key == glfw.KEY_A: self.state.command[0] += step
            elif key == glfw.KEY_D: self.state.command[0] -= step
            elif key == glfw.KEY_Q: self.state.command[2] += step
            elif key == glfw.KEY_E: self.state.command[2] -= step

------------------------------------------------
---  END OF FILE: keyboard_input_handler.py  ---
================================================================================

================================================================================
--- START OF FILE: main.py ---
------------------------------

# main.py
import sys
import numpy as np
import mujoco
import time # <-- æ–°å¢

from config import load_config
from state import SimulationState
from simulation import Simulation
from policy import ONNXPolicy
from observation import ObservationBuilder
from rendering import DebugOverlay
from keyboard_input_handler import KeyboardInputHandler
from xbox_input_handler import XboxInputHandler
from floating_controller import FloatingController
from serial_communicator import SerialCommunicator
from terrain_manager import TerrainManager
from hardware_controller import HardwareController # <-- æ–°å¢

def main():
    """ä¸»ç¨‹å¼å…¥å£ï¼šåˆå§‹åŒ–æ‰€æœ‰çµ„ä»¶ä¸¦é‹è¡Œæ¨¡æ“¬è¿´åœˆã€‚"""
    from xbox_controller import XboxController 
    print("\n--- æ©Ÿå™¨äººæ¨¡æ“¬æ§åˆ¶å™¨ (å«ç¡¬é«”æ¨¡å¼) ---")
    
    config = load_config()
    state = SimulationState(config)
    sim = Simulation(config)
    
    terrain_manager = TerrainManager(sim.model, sim.data)
    state.terrain_manager_ref = terrain_manager
    
    floating_controller = FloatingController(config, sim.model, sim.data)
    state.floating_controller_ref = floating_controller
    
    serial_comm = SerialCommunicator()
    xbox_handler = XboxInputHandler(state)
    
    try:
        assumed_dim = next(iter(config.observation_recipes))
        recipe = config.observation_recipes[assumed_dim]
    except StopIteration:
        sys.exit("âŒ éŒ¯èª¤: åœ¨ config.yaml ä¸­æ²’æœ‰å®šç¾©ä»»ä½• observation_recipesã€‚")

    obs_builder = ObservationBuilder(recipe, sim.data, sim.model, sim.torso_id, sim.default_pose, config)
    base_obs_dim = len(obs_builder.get_observation(np.zeros(3), np.zeros(config.num_motors)))
    policy = ONNXPolicy(config, base_obs_dim)
    state.policy_ref = policy
    
    # --- åˆå§‹åŒ–ç¡¬é«”æ§åˆ¶å™¨ ---
    hw_controller = HardwareController(config, policy, state)
    state.hardware_controller_ref = hw_controller # å°‡åƒè€ƒå­˜å…¥ state

    keyboard_handler = KeyboardInputHandler(state, serial_comm, xbox_handler, terrain_manager)
    keyboard_handler.register_callbacks(sim.window)

    if policy.model_input_dim != base_obs_dim:
        if policy.model_input_dim in config.observation_recipes:
            print(f"âš ï¸ ç¶­åº¦ä¸åŒ¹é…ï¼Œè‡ªå‹•åˆ‡æ›åˆ°ç¶­åº¦ {policy.model_input_dim} çš„æ­£ç¢ºé…æ–¹...")
            recipe = config.observation_recipes[policy.model_input_dim]
            obs_builder = ObservationBuilder(recipe, sim.data, sim.model, sim.torso_id, sim.default_pose, config)
            base_obs_dim = len(obs_builder.get_observation(np.zeros(3), np.zeros(config.num_motors)))
        else:
            sys.exit(f"âŒ è‡´å‘½éŒ¯èª¤: æ¨¡å‹æœŸæœ›ç¶­åº¦ ({policy.model_input_dim}) èˆ‡é…æ–¹ç”¢ç”Ÿçš„è§€å¯Ÿç¶­åº¦ ({base_obs_dim}) ä¸ç¬¦ï¼Œä¸”æ‰¾ä¸åˆ°åŒ¹é…é…æ–¹ï¼")

    ALL_OBS_DIMS = {'z_angular_velocity':1, 'gravity_vector':3, 'commands':3, 'joint_positions':12, 'joint_velocities':12, 'foot_contact_states':4, 'linear_velocity':3, 'angular_velocity':3, 'last_action':12, 'phase_signal':1}
    used_dims = {k: ALL_OBS_DIMS[k] for k in recipe if k in ALL_OBS_DIMS}
    overlay = DebugOverlay(recipe, used_dims)

    def hard_reset():
        """å®Œå…¨é‡ç½®æ•´å€‹æ¨¡æ“¬ç’°å¢ƒã€‚"""
        print("\n--- æ­£åœ¨åŸ·è¡Œå®Œå…¨é‡ç½® (Hard Reset) ---")
        if state.control_mode == "HARDWARE_MODE":
            print("ç¡¬é«”æ¨¡å¼ä¸‹ç„¡æ³•é‡ç½®æ¨¡æ“¬ã€‚")
            return
        sim.reset()
        policy.reset()
        if state.control_mode == "FLOATING": state.set_control_mode("WALKING")
        state.reset_control_state(sim.data.time)
        state.clear_command()
        state.joint_test_offsets.fill(0.0)
        state.manual_final_ctrl.fill(0.0)
        state.manual_mode_is_floating = False
        state.hard_reset_requested = False

    def soft_reset():
        """åƒ…é‡ç½®æ©Ÿå™¨äººå§¿æ…‹å’Œæ§åˆ¶å™¨ç‹€æ…‹ï¼Œä¸é‡ç½®æ¨¡æ“¬æ™‚é–“å’Œç‰©ç†ä¸–ç•Œã€‚"""
        print("\n--- æ­£åœ¨åŸ·è¡Œç©ºä¸­å§¿æ…‹é‡ç½® (Soft Reset) ---")
        if state.control_mode == "HARDWARE_MODE":
            print("ç¡¬é«”æ¨¡å¼ä¸‹ç„¡æ³•è»Ÿé‡ç½®ã€‚")
            return
        sim.data.qpos[7:] = sim.default_pose
        sim.data.qvel[6:] = 0
        policy.reset()
        state.clear_command()
        state.joint_test_offsets.fill(0.0)
        state.manual_final_ctrl.fill(0.0)
        state.manual_mode_is_floating = False
        mujoco.mj_forward(sim.model, sim.data)
        state.soft_reset_requested = False

    hard_reset()
    print("\n--- æ¨¡æ“¬é–‹å§‹ (SPACE: æš«åœ, N:ä¸‹ä¸€æ­¥) ---")
    print("    (F: æ‡¸æµ®, G: é—œç¯€æ¸¬è©¦, B: æ‰‹å‹•æ§åˆ¶, T: åºåˆ—åŸ , H: ç¡¬é«”æ¨¡å¼)")
    print("    (M: è¼¸å…¥æ¨¡å¼, R: ç¡¬é‡ç½®, X: è»Ÿé‡ç½®, U: æƒæåºåˆ—åŸ , J: æƒææ–æ¡¿)")
    print("    (åœ¨ç¡¬é«”æ¨¡å¼ä¸‹ï¼ŒæŒ‰ K å•Ÿç”¨/ç¦ç”¨ AI)")


    state.execute_one_step = False

    while not sim.should_close():
        # --- æ¨¡å¼ç„¡é—œçš„é€šç”¨æ›´æ–° ---
        if state.single_step_mode and not state.execute_one_step:
            sim.render(state, overlay)
            continue
        if state.execute_one_step: state.execute_one_step = False

        if state.input_mode == "GAMEPAD": xbox_handler.update_state()
        if state.hard_reset_requested: hard_reset()
        if state.soft_reset_requested: soft_reset()

        state.latest_pos = sim.data.body('torso').xpos.copy()
        state.latest_quat = sim.data.body('torso').xquat.copy()

        # --- æ¨¡å¼åˆ†æ´¾é‚è¼¯ ---
        if state.control_mode == "HARDWARE_MODE":
            # åœ¨ç¡¬é«”æ¨¡å¼ä¸‹ï¼ŒPython ä¸»åŸ·è¡Œç·’æ¯”è¼ƒé–’ç½®ï¼Œä¸»è¦è² è²¬æ›´æ–°UI
            # çœŸæ­£çš„æ§åˆ¶åœ¨ hw_controller çš„èƒŒæ™¯åŸ·è¡Œç·’ä¸­
            if hw_controller.is_running:
                with hw_controller.lock:
                    t_since_update = time.time() - hw_controller.hw_state.last_update_time
                    conn_status = f"æ•¸æ“šå»¶é²: {t_since_update:.2f}s" if t_since_update < 1.0 else "æ•¸æ“šè¶…æ™‚!"
                    state.hardware_status_text = f"é€£æ¥ç‹€æ…‹: {conn_status}\n"
                    state.hardware_status_text += f"LinVel: {np.array2string(hw_controller.hw_state.lin_vel_local, precision=2)}\n"
                    state.hardware_status_text += f"Gyro: {np.array2string(hw_controller.hw_state.imu_gyro_radps, precision=2)}"
            else:
                state.hardware_status_text = "ç¡¬é«”æ§åˆ¶å™¨æœªé‹è¡Œã€‚"
            # åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œä¸åŸ·è¡Œæ¨¡æ“¬æ­¥é€²ï¼Œåªæ¸²æŸ“
        
        elif state.control_mode == "SERIAL_MODE":
            # åºåˆ—åŸ ä¸»æ§å°æ¨¡å¼ä¸‹ä¹Ÿä¸åŸ·è¡Œæ¨¡æ“¬æ­¥é€²
            if state.serial_is_connected: state.serial_latest_messages = serial_comm.get_latest_messages()
            if state.serial_command_to_send:
                serial_comm.send_command(state.serial_command_to_send)
                state.serial_command_to_send = ""
        else:
            # æ‰€æœ‰æ¨¡æ“¬ç›¸é—œçš„æ¨¡å¼ (WALKING, FLOATING, JOINT_TEST, MANUAL_CTRL)
            if state.single_step_mode: print("\n" + "="*20 + f" STEP AT TIME {sim.data.time:.4f} " + "="*20)

            base_obs = obs_builder.get_observation(state.command, policy.last_action)
            onnx_input, action_raw = policy.get_action(base_obs)
            state.latest_onnx_input = onnx_input.flatten()
            state.latest_action_raw = action_raw

            if state.control_mode == "MANUAL_CTRL":
                final_ctrl = state.manual_final_ctrl.copy() 
            elif state.control_mode == "JOINT_TEST":
                final_ctrl = sim.default_pose + state.joint_test_offsets
            else: # WALKING or FLOATING
                final_ctrl = sim.default_pose + action_raw * state.tuning_params.action_scale

            state.latest_final_ctrl = final_ctrl
            sim.apply_position_control(final_ctrl, state.tuning_params)
            
            target_time = sim.data.time + config.control_dt
            while sim.data.time < target_time:
                mujoco.mj_step(sim.model, sim.data)

        # æ¸²æŸ“æ°¸é åœ¨è¿´åœˆçš„æœ€å¾ŒåŸ·è¡Œ
        sim.render(state, overlay)

    # --- ç¨‹å¼çµæŸæ™‚ï¼Œç¢ºä¿æ‰€æœ‰è³‡æºéƒ½è¢«å®‰å…¨é—œé–‰ ---
    hw_controller.stop()
    sim.close()
    xbox_handler.close()
    serial_comm.close()
    print("\nç¨‹å¼å·²å®‰å…¨é€€å‡ºã€‚")

if __name__ == "__main__":
    main()

------------------------------
---  END OF FILE: main.py  ---
================================================================================

================================================================================
--- START OF FILE: observation.py ---
-------------------------------------

# observation.py
import numpy as np
import mujoco
from config import AppConfig

class ObservationBuilder:
    def __init__(self, recipe: list, data, model, torso_id, default_pose, config: AppConfig):
        self.recipe = recipe
        self.data = data
        self.model = model
        self.torso_id = torso_id
        # åœ¨çµ•å°è§’åº¦æ¨¡å¼ä¸‹ï¼Œdefault_pose ä¸»è¦ç”¨æ–¼é‡ç½®å’Œé—œç¯€æ¸¬è©¦æ¨¡å¼
        self.default_pose = default_pose
        self.config = config
        self._component_generators = self._register_components()
        for component in self.recipe:
            if component not in self._component_generators:
                print(f"âš ï¸ è­¦å‘Š: è§€å¯Ÿé…æ–¹ä¸­çš„å…ƒä»¶ '{component}' æ²’æœ‰å°æ‡‰çš„ç”¢ç”Ÿå™¨å‡½å¼ï¼Œå°‡è¢«å¿½ç•¥ã€‚")

    def _register_components(self):
        """è¨»å†Šæ‰€æœ‰å·²çŸ¥çš„è§€å¯Ÿå…ƒä»¶åŠå…¶å°æ‡‰çš„ç”¢ç”Ÿå™¨å‡½å¼ã€‚"""
        return {
            'z_angular_velocity': self._get_z_angular_velocity,
            'gravity_vector': self._get_gravity_vector,
            'commands': self._get_commands,
            'joint_positions': self._get_joint_positions,
            'last_action': self._get_last_action,
            'linear_velocity': self._get_linear_velocity,
            'angular_velocity': self._get_full_angular_velocity,
            'joint_velocities': self._get_joint_velocities,
            'foot_contact_states': self._get_foot_contact_states,
            'phase_signal': self._get_phase_signal,
        }

    def get_observation(self, command, last_action) -> np.ndarray:
        """æ ¹æ“šé…æ–¹åˆ—è¡¨ï¼Œä¾åºå‘¼å«ç”¢ç”Ÿå™¨å‡½å¼ä¸¦æ‹¼æ¥æˆæœ€çµ‚çš„è§€å¯Ÿå‘é‡ã€‚"""
        obs_list = []
        for name in self.recipe:
            if name in self._component_generators:
                obs_list.append(self._component_generators[name](command=command, last_action=last_action))
        
        if not obs_list:
            return np.array([], dtype=np.float32)

        return np.concatenate(obs_list).astype(np.float32)

    def _get_torso_inverse_rotation(self):
        """è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—è»€å¹¹å§¿æ…‹çš„é€†å››å…ƒæ•¸ã€‚"""
        torso_quat = self.data.xquat[self.torso_id]
        norm = np.sum(np.square(torso_quat))
        if norm < 1e-8: torso_quat = np.array([1., 0, 0, 0])
        torso_quat /= np.sqrt(np.sum(np.square(torso_quat)))
        return np.array([torso_quat[0], -torso_quat[1], -torso_quat[2], -torso_quat[3]]) / np.sum(np.square(torso_quat))

    def _rotate_vec_by_quat_inv(self, v, q_inv):
        """è¼”åŠ©å‡½å¼ï¼šä½¿ç”¨é€†å››å…ƒæ•¸å°‡ä¸–ç•Œåº§æ¨™ç³»å‘é‡è½‰æ›ç‚ºå±€éƒ¨åº§æ¨™ç³»ã€‚"""
        u, s = q_inv[1:], q_inv[0]
        return 2 * np.dot(u, v) * u + (s * s - np.dot(u, u)) * v + 2 * s * np.cross(u, v)

    def _get_z_angular_velocity(self, **kwargs):
        inv_torso_rot = self._get_torso_inverse_rotation()
        local_rpy_rate = self._rotate_vec_by_quat_inv(self.data.cvel[self.torso_id, 0:3], inv_torso_rot)
        return np.array([local_rpy_rate[2]]) * 0.25

    def _get_gravity_vector(self, **kwargs):
        inv_torso_rot = self._get_torso_inverse_rotation()
        return self._rotate_vec_by_quat_inv(np.array([0, 0, -1]), inv_torso_rot)

    def _get_commands(self, command, **kwargs):
        return command * np.array(self.config.command_scaling_factors) 

    def _get_joint_positions(self, **kwargs):
        # =================================================================
        # === ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç›´æ¥è¿”å›é—œç¯€çš„ã€çµ•å°è§’åº¦ã€‘                    ===
        # === é€™æ¨£ AI è§€å¯Ÿåˆ°çš„å°±æ˜¯çœŸå¯¦çš„ç‰©ç†ä¸–ç•Œçš„è§’åº¦å€¼ã€‚            ===
        # =================================================================
        return self.data.qpos[7:] - self.default_pose


    def _get_joint_velocities(self, **kwargs):
        return self.data.qvel[6:].copy() # ç§»é™¤ * 0.05ï¼Œä¸¦åŠ ä¸Š .copy() ä»¥ç¢ºä¿å®‰å…¨

    def _get_foot_contact_states(self, **kwargs):
        foot_geom_names = ['FR', 'FL', 'RR', 'RL']
        foot_geom_ids = [mujoco.mj_name2id(self.model, mujoco.mjtObj.mjOBJ_GEOM, name) for name in foot_geom_names]
        contacts = np.zeros(4, dtype=np.float32)
        for i in range(self.data.ncon):
            con = self.data.contact[i]
            for foot_idx, foot_geom_id in enumerate(foot_geom_ids):
                if foot_geom_id != -1 and (con.geom1 == foot_geom_id or con.geom2 == foot_geom_id):
                    contacts[foot_idx] = 1.0
                    break
        return contacts

    def _get_last_action(self, last_action, **kwargs):
        # åœ¨çµ•å°è§’åº¦æ¨¡å¼ä¸‹ï¼Œlast_action å°±æ˜¯ä¸Šä¸€å€‹ç›®æ¨™çµ•å°è§’åº¦
        return last_action

    def _get_linear_velocity(self, **kwargs):
        inv_torso_rot = self._get_torso_inverse_rotation()
        return self._rotate_vec_by_quat_inv(self.data.cvel[self.torso_id, 3:], inv_torso_rot)

    def _get_full_angular_velocity(self, **kwargs):
        inv_torso_rot = self._get_torso_inverse_rotation()
        return self._rotate_vec_by_quat_inv(self.data.cvel[self.torso_id, :3], inv_torso_rot)
        
    def _get_phase_signal(self, **kwargs):
        return np.array([self.data.time % 1.0], dtype=np.float32)

-------------------------------------
---  END OF FILE: observation.py  ---
================================================================================

================================================================================
--- START OF FILE: policy.py ---
--------------------------------

# policy.py
import numpy as np
import onnxruntime as ort
import sys
import os
from collections import deque
from config import AppConfig

class ONNXPolicy:
    """
    å°è£ ONNX æ¨¡å‹çš„è¼‰å…¥ã€è§€å¯Ÿæ­·å²ç®¡ç†å’Œæ¨è«–é‚è¼¯ã€‚
    """
    def __init__(self, config: AppConfig, base_obs_dim: int):
        self.config = config
        self.base_obs_dim = base_obs_dim
        
        print(f"æ­£åœ¨è¼‰å…¥ ONNX æ¨¡å‹: {config.onnx_model_path}")
        sess_options = ort.SessionOptions()
        cache_path = os.path.splitext(config.onnx_model_path)[0] + ".optimized.ort"
        
        if os.path.exists(cache_path):
            print(f"âš¡ï¸ ç™¼ç¾å„ªåŒ–æ¨¡å‹å¿«å–ï¼Œå°‡å¾ '{cache_path}' å¿«é€Ÿè¼‰å…¥ã€‚")
        else:
            print(f"ğŸ¢ é¦–æ¬¡è¼‰å…¥ï¼Œå°‡å‰µå»ºå„ªåŒ–æ¨¡å‹å¿«å–æ–¼ '{cache_path}' (å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“)...")

        sess_options.optimized_model_filepath = cache_path
        sess_options.graph_optimization_level = ort.GraphOptimizationLevel.ORT_ENABLE_ALL

        try:
            self.sess = ort.InferenceSession(
                config.onnx_model_path, 
                sess_options=sess_options,
                providers=['CPUExecutionProvider']
            )
        except Exception as e:
            sys.exit(f"âŒ éŒ¯èª¤: ç„¡æ³•è¼‰å…¥ ONNX æ¨¡å‹ '{config.onnx_model_path}': {e}")

        self.input_name = self.sess.get_inputs()[0].name
        self.output_name = self.sess.get_outputs()[0].name
        self.model_input_dim = self.sess.get_inputs()[0].shape[1]
        
        print(f"âœ… æ¨¡å‹è¼‰å…¥æˆåŠŸ! æ¨¡å‹æœŸæœ›è¼¸å…¥ç¶­åº¦: {self.model_input_dim}")
        self._determine_history_length()

        self.obs_history = deque(
            [np.zeros(self.base_obs_dim, dtype=np.float32)] * self.history_length, 
            maxlen=self.history_length
        )
        self.last_action = np.zeros(config.num_motors, dtype=np.float32)

    def _determine_history_length(self):
        """æ ¹æ“šæ¨¡å‹è¼¸å…¥ç¶­åº¦å’ŒåŸºç¤è§€å¯Ÿç¶­åº¦ï¼Œè‡ªå‹•è¨ˆç®—æ­·å²é•·åº¦ã€‚"""
        if self.base_obs_dim == 0:
            print("âš ï¸ è­¦å‘Š: åŸºç¤è§€å¯Ÿç¶­åº¦ç‚º 0ï¼Œç„¡æ³•è¨ˆç®—æ­·å²é•·åº¦ã€‚")
            self.history_length = 0
            return
            
        if self.model_input_dim % self.base_obs_dim != 0:
            print(
                f"âš ï¸ è­¦å‘Š: åŸºç¤è§€å¯Ÿç¶­åº¦ ({self.base_obs_dim}) ç„¡æ³•æ•´é™¤æ¨¡å‹è¼¸å…¥ç¶­åº¦ "
                f"({self.model_input_dim})ã€‚æ­·å²å †ç–ŠåŠŸèƒ½å¯èƒ½ä¸æº–ç¢ºã€‚"
            )
            self.history_length = 1
        else:
            self.history_length = self.model_input_dim // self.base_obs_dim
        
        if self.history_length > 1:
            print(f"ğŸ¤– è‡ªå‹•åµæ¸¬åˆ°æ¨¡å‹ä½¿ç”¨æ­·å²å †ç–Šï¼Œé•·åº¦ç‚º: {self.history_length} å¹€ã€‚")
        else:
            print("ğŸ¤– æ¨¡å‹åƒ…ä½¿ç”¨ç•¶å‰è§€å¯Ÿ (æ­·å²é•·åº¦ = 1)ã€‚")

    def get_action(self, base_obs: np.ndarray) -> tuple[np.ndarray, np.ndarray]:
        """æ ¹æ“šç•¶å‰çš„åŸºç¤è§€å¯Ÿï¼Œæ›´æ–°æ­·å²ä¸¦åŸ·è¡Œæ¨¡å‹æ¨è«–ï¼Œå›å‚³å‹•ä½œã€‚"""
        if self.history_length == 0:
            return np.array([]), np.zeros(self.config.num_motors)

        self.obs_history.append(base_obs)
        onnx_input = np.concatenate(list(self.obs_history)).astype(np.float32).reshape(1, -1)
        
        if onnx_input.shape[1] != self.model_input_dim:
            return onnx_input, np.zeros(self.config.num_motors)
            
        action_raw = self.sess.run([self.output_name], {self.input_name: onnx_input})[0].flatten()
        self.last_action[:] = action_raw
        return onnx_input, action_raw

    def reset(self):
        """é‡ç½®è§€å¯Ÿæ­·å²å’Œä¸Šä¸€å€‹å‹•ä½œã€‚"""
        self.obs_history.clear()
        if self.history_length > 0:
            for _ in range(self.history_length):
                self.obs_history.append(np.zeros(self.base_obs_dim, dtype=np.float32))
        self.last_action.fill(0.0)
        print("âœ… ONNX ç­–ç•¥ç‹€æ…‹å·²é‡ç½®ã€‚")

--------------------------------
---  END OF FILE: policy.py  ---
================================================================================

================================================================================
--- START OF FILE: readme.md ---
--------------------------------

å‰ç½®å®‰è£ï¼šä½ éœ€è¦å®‰è£ PyYAMLã€‚åœ¨ä½ çš„çµ‚ç«¯æ©Ÿä¸­åŸ·è¡Œï¼š
pip install onnxruntime numpy
pip install PyYAML
pip install mujoco glfw //é€™å€‹çœ‹çœ‹ç’°å¢ƒæœ‰æ²’æœ‰è¼‰ï¼Œæˆ‘ä¸æ˜¯ç”¨é€™å€‹
pip install inputs //æ–æ¡¿ç”¨çš„
pip install pygame
pip install pyserial



--------------------------------
---  END OF FILE: readme.md  ---
================================================================================

================================================================================
--- START OF FILE: rendering.py ---
-----------------------------------

# rendering.py
import mujoco
import numpy as np
import time
from state import SimulationState
from typing import TYPE_CHECKING, List, Dict

if TYPE_CHECKING:
    from simulation import Simulation
    from serial_communicator import SerialCommunicator

class DebugOverlay:
    """
    è² è²¬åœ¨ MuJoCo è¦–çª—ä¸Šæ¸²æŸ“æ‰€æœ‰æ–‡å­—é™¤éŒ¯è³‡è¨Šã€‚
    """
    def __init__(self, recipe: List[str], recipe_dims: Dict[str, int]):
        self.recipe = recipe
        self.component_dims = recipe_dims
        self.display_pages_content = [
            ['linear_velocity', 'angular_velocity', 'gravity_vector', 'commands'],
            ['joint_positions', 'joint_velocities', 'last_action'],
        ]
        state_class_ref = SimulationState
        state_class_ref.num_display_pages = len(self.display_pages_content)

    def render(self, viewport, context, state: SimulationState, sim: "Simulation"):
        """æ ¹æ“šç•¶å‰æ§åˆ¶æ¨¡å¼ï¼Œé¸æ“‡ä¸¦å‘¼å«å°æ‡‰çš„æ¸²æŸ“å‡½å¼ã€‚"""
        if state.control_mode == "HARDWARE_MODE":
            self.render_hardware_overlay(viewport, context, state)
        elif state.control_mode == "SERIAL_MODE":
            self.render_serial_console(viewport, context, state)
        elif state.control_mode == "JOINT_TEST":
            self.render_joint_test_overlay(viewport, context, state, sim)
        elif state.control_mode == "MANUAL_CTRL":
            self.render_manual_ctrl_overlay(viewport, context, state, sim)
        else:
            self.render_simulation_overlay(viewport, context, state, sim)

    def render_hardware_overlay(self, viewport, context, state: SimulationState):
        """æ¸²æŸ“ç¡¬é«”æ§åˆ¶æ¨¡å¼çš„å°ˆç”¨ä»‹é¢ã€‚"""
        # ç¹ªè£½ä¸€å€‹æ·±è‰²åŠé€æ˜èƒŒæ™¯ï¼Œä»¥ç¤ºå€åˆ¥
        mujoco.mjr_rectangle(viewport, 0.1, 0.1, 0.1, 0.95)
        
        ai_status = "å•Ÿç”¨" if state.hardware_ai_is_active else "ç¦ç”¨"
        title = f"--- HARDWARE CONTROL MODE (AI: {ai_status}) ---"
        help_text = "Press 'H' to exit to simulation mode | Press 'K' to toggle AI control"
        
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_BIG, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, title, None, context)
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, "\n\n" + help_text, " ", context)

        # é¡¯ç¤ºä¾†è‡ª state çš„å³æ™‚ç¡¬é«”ç‹€æ…‹æ–‡å­—
        status_text = f"\n\n\n\n--- Real-time Hardware Status ---\n{state.hardware_status_text}"
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, status_text, None, context)
        
        # ä¹Ÿå¯ä»¥é¡¯ç¤ºä½¿ç”¨è€…å‘½ä»¤
        user_cmd_text = f"\n--- User Command ---\nvy: {state.command[0]:.2f}, vx: {state.command[1]:.2f}, wz: {state.command[2]:.2f}"
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_BOTTOMLEFT, viewport, user_cmd_text, None, context)

    def render_serial_console(self, viewport, context, state: SimulationState):
        """æ¸²æŸ“ä¸€å€‹å…¨è¢å¹•çš„åºåˆ—åŸ æ§åˆ¶å°ä»‹é¢ã€‚"""
        mujoco.mjr_rectangle(viewport, 0.2, 0.2, 0.2, 0.9)
        title = "--- SERIAL CONSOLE MODE (Press T to exit) ---"
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_BIG, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, title, None, context)
        log_text = "\n".join(state.serial_latest_messages)
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, "\n\n" + log_text, " ", context)
        cursor = "_" if int(time.time() * 2) % 2 == 0 else " "
        buffer_text = f"> {state.serial_command_buffer}{cursor}"
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_BOTTOMLEFT, viewport, buffer_text, None, context)
    
    def render_joint_test_overlay(self, viewport, context, state: SimulationState, sim: "Simulation"):
        """æ¸²æŸ“é—œç¯€æ‰‹å‹•æ¸¬è©¦æ¨¡å¼çš„å°ˆç”¨ä»‹é¢ã€‚"""
        mujoco.mjr_rectangle(viewport, 0.2, 0.25, 0.3, 0.9)
        help_text = (
            "--- JOINT TEST MODE ---\n\n"
            "Press '[ / ]' to Select Joint\n"
            "Press UP / DOWN to Adjust Offset\n"
            "Press 'C' to Clear All Offsets\n\n"
            "Press 'G' to Return to Walking Mode"
        )
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_BIG, mujoco.mjtGridPos.mjGRID_TOPRIGHT, viewport, help_text, None, context)
        joint_names = [
            "0: FR_Abduction", "1: FR_Hip", "2: FR_Knee",
            "3: FL_Abduction", "4: FL_Hip", "5: FL_Knee",
            "6: RR_Abduction", "7: RR_Hip", "8: RR_Knee",
            "9: RL_Abduction", "10: RL_Hip", "11: RL_Knee"
        ]
        num_joints_per_col = 6
        left_col_text, right_col_text = "", ""
        for i, name in enumerate(joint_names):
            prefix = ">> " if i == state.joint_test_index else "   "
            offset_val = state.joint_test_offsets[i]
            final_val = sim.default_pose[i] + offset_val
            line_text = f"{prefix}{name:<15}: Offset={offset_val:+.2f}, Final={final_val:+.2f}\n"
            if i < num_joints_per_col: left_col_text += line_text
            else: right_col_text += line_text
        
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, left_col_text, None, context)
        right_col_rect = mujoco.MjrRect(int(viewport.width * 0.45), 0, int(viewport.width * 0.55), viewport.height)
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, right_col_rect, right_col_text, None, context)

    def render_manual_ctrl_overlay(self, viewport, context, state: SimulationState, sim: "Simulation"):
        """æ¸²æŸ“æ‰‹å‹• Final Ctrl æ¨¡å¼çš„å°ˆç”¨ä»‹é¢ã€‚"""
        floating_status = "Floating" if state.manual_mode_is_floating else "On Ground"
        help_title = f"--- MANUAL CTRL MODE ({floating_status}) ---"

        help_text = (
            f"{help_title}\n\n"
            "Press 'F' to Toggle Floating\n\n"
            "Press '[ / ]' to Select Joint\n"
            "Press UP / DOWN to Adjust Target Angle\n"
            "Press 'C' to Reset All Targets to 0\n\n"
            "Press 'G' to Return to Walking Mode"
        )
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPRIGHT, viewport, help_text, None, context)
        
        joint_names = [
            "0: FR_Abduction", "1: FR_Hip", "2: FR_Knee",
            "3: FL_Abduction", "4: FL_Hip", "5: FL_Knee",
            "6: RR_Abduction", "7: RR_Hip", "8: RR_Knee",
            "9: RL_Abduction", "10: RL_Hip", "11: RL_Knee"
        ]
        num_joints_per_col = 6
        left_col_text, right_col_text = "", ""
        
        current_joint_positions = sim.data.qpos[7:]
        
        for i, name in enumerate(joint_names):
            prefix = ">> " if i == state.manual_ctrl_index else "   "
            target_val = state.manual_final_ctrl[i]
            actual_val = current_joint_positions[i]
            error = target_val - actual_val
            
            line_text = f"{prefix}{name:<15}: Target={target_val:+.2f}, Actual={actual_val:+.2f}, Err={error:+.2f}\n"
            
            if i < num_joints_per_col:
                left_col_text += line_text
            else:
                right_col_text += line_text
        
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, left_col_text, None, context)
        
        right_col_rect = mujoco.MjrRect(int(viewport.width * 0.40), 0, int(viewport.width * 0.60), viewport.height)
        
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, right_col_rect, right_col_text, None, context)

    def render_simulation_overlay(self, viewport, context, state: SimulationState, sim: "Simulation"):
        """æ¸²æŸ“æ­£å¸¸çš„æ¨¡æ“¬é™¤éŒ¯è³‡è¨Šã€‚"""
        def format_vec(label: str, vec, precision=3, label_width=24):
            if vec is None or vec.size == 0: return f"{label:<{label_width}}None"
            vec_str = np.array2string(vec, precision=precision, floatmode='fixed', suppress_small=True, threshold=100)
            return f"{label:<{label_width}}{vec_str}"

        help_text = (
            "--- CONTROLS ---\n\n"
            "[Universal]\n"
            "  SPACE: Pause/Play | N: Next Step\n"
            "  F: Float | G: Joint Test/Exit | B: Manual Ctrl\n"
            "  ESC: Exit       | R: Reset       | T: Serial Console\n"
            "  X: Soft Reset   | TAB: Info Page | H: Hardware Mode\n"
            "  M: Input Mode   | C: Clear Cmd (Kbd)\n"
            "  U: Scan Serial  | J: Scan Gamepad\n"
            "  V: Cycle Terrain  | K: Toggle HW AI\n\n"
            "[Keyboard Mode]\n"
            "  WASD/QE: Move/Turn\n"
            "  [/]: Select Param | UP/DOWN: Adjust Value\n\n"
            "[Gamepad Mode]\n"
            "  L-Stick: Move | R-Stick: Turn\n"
            "  LB/RB: Select Param | D-Pad U/D: Adjust Value\n"
            "  Select/View: Reset"
        )
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPRIGHT, viewport, help_text, None, context)

        serial_status = "Connected" if state.serial_is_connected else "Disconnected (U to Scan)"
        gamepad_status = "Connected" if state.gamepad_is_connected else "Disconnected (J to Scan)"
        terrain_name = state.terrain_manager_ref.get_current_terrain_name() if state.terrain_manager_ref else "N/A"

        p = state.tuning_params
        prefixes = ["   "] * 4
        prefixes[state.tuning_param_index] = ">> "

        top_left_text = (
            f"Mode: {state.control_mode} | Input: {state.input_mode}\n"
            f"Time: {sim.data.time:.2f} s\n"
            f"Terrain: {terrain_name}\n\n"
            f"--- Devices ---\n"
            f"Serial Console: {serial_status}\n"
            f"Gamepad: {gamepad_status}\n\n"
            f"--- Tuning Params ---\n"
            f"{prefixes[0]}{format_vec('Kp:', np.array([p.kp]), 1)}\n"
            f"{prefixes[1]}{format_vec('Kd:', np.array([p.kd]), 2)}\n"
            f"{prefixes[2]}{format_vec('Act Scale:', np.array([p.action_scale]), 3)}\n"
            f"{prefixes[3]}{format_vec('Bias:', np.array([p.bias]), 1)}\n\n"
            f"--- Command ---\n"
            f"{format_vec('User Cmd:', state.command)}\n"
        )

        if state.control_mode == "FLOATING":
            current_height = sim.data.qpos[2]
            target_height = sim.config.floating_controller.target_height
            top_left_text += (
                f"\n--- Floating Info ---\n"
                f"{format_vec('Target H:', np.array([target_height]), 3)}\n"
                f"{format_vec('Current H:', np.array([current_height]), 3)}\n"
            )
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_TOPLEFT, viewport, top_left_text, None, context)
        
        bottom_left_text = f"--- ONNX INPUTS (Page {state.display_page + 1}/{state.num_display_pages}) ---\n"
        onnx_input_vec = state.latest_onnx_input
        if onnx_input_vec.size > 0 and state.display_page < len(self.display_pages_content):
            current_page_components = self.display_pages_content[state.display_page]
            base_obs_dim = sum(self.component_dims.values()) if self.component_dims else 0
            if base_obs_dim > 0:
                history_len = len(onnx_input_vec) // base_obs_dim
                current_full_obs_idx = 0
                for comp_name_in_recipe in self.recipe:
                    dim = self.component_dims.get(comp_name_in_recipe, 0)
                    if dim > 0:
                        if comp_name_in_recipe in current_page_components:
                            start_idx, end_idx = current_full_obs_idx, current_full_obs_idx + dim
                            value_slice = onnx_input_vec[start_idx:end_idx]
                            bottom_left_text += format_vec(f"{comp_name_in_recipe} [{dim}d]:", value_slice, 2) + "\n"
                        current_full_obs_idx += dim
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_BOTTOMLEFT, viewport, bottom_left_text, None, context)
        
        torso_lin_vel = sim.data.cvel[sim.torso_id, 3:]
        torso_ang_vel_local = self._get_local_ang_vel(sim.data, sim.torso_id)
        bottom_right_text = (
            f"--- ONNX OUTPUTS & STATE ---\n"
            f"{format_vec('Raw Action:', state.latest_action_raw)}\n"
            f"{format_vec('Final Ctrl:', state.latest_final_ctrl)}\n\n"
            f"--- Robot State (Sim) ---\n"
            f"{format_vec('Torso Z:', np.array([sim.data.qpos[2]]))}\n"
            f"{format_vec('Lin Vel (World):', torso_lin_vel)}\n"
            f"{format_vec('Ang Vel (Local):', torso_ang_vel_local)}"
        )
        mujoco.mjr_overlay(mujoco.mjtFont.mjFONT_NORMAL, mujoco.mjtGridPos.mjGRID_BOTTOMRIGHT, viewport, bottom_right_text, None, context)
    
    def _get_local_ang_vel(self, data, torso_id):
        """è¼”åŠ©å‡½å¼ï¼Œè¨ˆç®—å±€éƒ¨è§’é€Ÿåº¦ç”¨æ–¼é¡¯ç¤ºã€‚"""
        torso_quat = data.xquat[torso_id]
        norm = np.sum(np.square(torso_quat))
        if norm < 1e-8: return np.zeros(3)
        torso_quat /= np.sqrt(norm)
        q_inv = np.array([torso_quat[0], -torso_quat[1], -torso_quat[2], -torso_quat[3]]) / norm
        u, s = q_inv[1:], q_inv[0]
        world_ang_vel = data.cvel[torso_id, :3]
        return 2 * np.dot(u, world_ang_vel) * u + (s*s - np.dot(u, u)) * world_ang_vel + 2*s*np.cross(u, world_ang_vel)

-----------------------------------
---  END OF FILE: rendering.py  ---
================================================================================

================================================================================
--- START OF FILE: serial_communicator.py ---
---------------------------------------------

# serial_communicator.py
import serial
import time
import sys
import threading
import serial.tools.list_ports
from collections import deque

class SerialCommunicator:
    """
    ä¸€å€‹é¡åˆ¥ï¼Œå°è£äº†èˆ‡åºåˆ—åŸ è¨­å‚™çš„é€šè¨Šé‚è¼¯ã€‚
    å®ƒä½¿ç”¨èƒŒæ™¯åŸ·è¡Œç·’ä¾†éé˜»å¡åœ°è®€å–æ•¸æ“šã€‚
    """
    def __init__(self, max_log_lines=15):
        """
        åˆå§‹åŒ–é€šè¨Šå™¨ï¼Œä½†ä¸ç«‹å³é€£æ¥ã€‚
        """
        self.ser = None
        self.read_thread = None
        self.exit_signal = threading.Event()
        self.is_connected = False
        self.port_name = None
        self.message_log = deque(maxlen=max_log_lines)
        print("âœ… åºåˆ—åŸ é€šè¨Šå™¨å·²åˆå§‹åŒ– (ç­‰å¾…é€£æ¥æŒ‡ä»¤)ã€‚")

    def scan_and_connect(self) -> bool:
        """
        æƒæåºåˆ—åŸ ï¼Œè®“ä½¿ç”¨è€…åœ¨çµ‚ç«¯æ©Ÿé¸æ“‡ï¼Œä¸¦å˜—è©¦é€£æ¥ã€‚
        è¿”å›é€£æ¥æ˜¯å¦æˆåŠŸã€‚
        """
        if self.is_connected:
            print("åºåˆ—åŸ å·²é€£æ¥ï¼Œç„¡éœ€é‡æ–°æƒæã€‚")
            return True
            
        selected_port = self._select_serial_port()
        if selected_port:
            self.port_name = selected_port
            return self.connect()
        return False

    def _select_serial_port(self):
        """
        æƒæä¸¦è®“ä½¿ç”¨è€…é¸æ“‡åºåˆ—åŸ ã€‚å„ªå…ˆè‡ªå‹•æª¢æ¸¬ Teensyã€‚
        è¿”å›é¸å®šçš„åºåˆ—åŸ åç¨±ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å› Noneã€‚
        """
        print("\n" + "="*20 + " æ­£åœ¨æƒæåºåˆ—åŸ  " + "="*20)
        ports = serial.tools.list_ports.comports()
        if not ports:
            print("--- æœªæ‰¾åˆ°ä»»ä½•åºåˆ—åŸ  ---")
            return None

        teensy_ports = [p for p in ports if p.vid == 0x16C0 and p.pid == 0x0483]
        if len(teensy_ports) == 1:
            print(f"è‡ªå‹•æª¢æ¸¬åˆ° Teensy: {teensy_ports[0].device}")
            return teensy_ports[0].device
        
        print("\nè«‹å¾ä»¥ä¸‹åˆ—è¡¨ä¸­é¸æ“‡æ‚¨çš„è¨­å‚™:")
        for i, port in enumerate(ports):
            print(f"  [{i}] {port.device} - {port.description}")
        while True:
            try:
                choice_str = input(f"è«‹è¼¸å…¥é¸æ“‡çš„ç·¨è™Ÿ (0-{len(ports)-1}) æˆ–ç›´æ¥æŒ‰ Enter è·³é: ")
                if not choice_str:
                    print("å·²è·³éåºåˆ—åŸ é¸æ“‡ã€‚")
                    return None
                choice = int(choice_str)
                if 0 <= choice < len(ports):
                    return ports[choice].device
                else:
                    print("è¼¸å…¥ç„¡æ•ˆï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚")
            except (ValueError, IndexError):
                print("è¼¸å…¥ç„¡æ•ˆï¼Œè«‹è¼¸å…¥åˆ—è¡¨ä¸­çš„æ•¸å­—ã€‚")

    def connect(self, baud_rate=115200) -> bool:
        """é€£æ¥åˆ°æŒ‡å®šçš„åºåˆ—åŸ ä¸¦å•Ÿå‹•è®€å–åŸ·è¡Œç·’ã€‚"""
        if not self.port_name: return False
        try:
            print(f"æ­£åœ¨é€£æ¥åˆ° {self.port_name}...")
            self.ser = serial.Serial(self.port_name, baud_rate, timeout=0.1)
            time.sleep(0.5)
            self.ser.reset_input_buffer()
            self.ser.reset_output_buffer()
            
            self.exit_signal.clear()
            self.read_thread = threading.Thread(target=self._read_from_port, daemon=True)
            self.read_thread.start()
            self.is_connected = True
            print(f"âœ… åºåˆ—åŸ  {self.port_name} é€£æ¥æˆåŠŸã€‚")
            return True

        except serial.SerialException as e:
            print(f"âŒ åºåˆ—åŸ é€£æ¥å¤±æ•—: {e}")
            self.is_connected = False
            return False

    def _read_from_port(self):
        """åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸­è®€å–æ•¸æ“šä¸¦å­˜å…¥æ—¥èªŒã€‚"""
        while not self.exit_signal.is_set():
            try:
                if self.ser and self.ser.is_open and self.ser.in_waiting > 0:
                    response = self.ser.readline().decode('utf-8', 'ignore').strip()
                    if response:
                        self.message_log.append(response)
            except serial.SerialException:
                self.message_log.append("[éŒ¯èª¤] åºåˆ—åŸ å·²æ–·é–‹ã€‚")
                self.is_connected = False
                break
            time.sleep(0.01)

    def send_command(self, command: str):
        """å‘åºåˆ—åŸ ç™¼é€æŒ‡ä»¤ã€‚"""
        if self.is_connected and command:
            try:
                command_to_send = command + '\n'
                self.ser.write(command_to_send.encode('utf-8'))
                self.message_log.append(f"> {command}")
            except serial.SerialException as e:
                 self.message_log.append(f"[éŒ¯èª¤] ç™¼é€å¤±æ•—: {e}")
                 self.is_connected = False

    def get_latest_messages(self) -> list:
        """ç²å–æ—¥èªŒä¸­çš„æ‰€æœ‰è¨Šæ¯ã€‚"""
        return list(self.message_log)

    def close(self):
        """å®‰å…¨åœ°é—œé–‰åºåˆ—åŸ å’Œè®€å–åŸ·è¡Œç·’ã€‚"""
        if self.read_thread and self.read_thread.is_alive():
            self.exit_signal.set()
            self.read_thread.join(timeout=1)
        if self.ser and self.ser.is_open:
            self.ser.close()
            print(f"åºåˆ—åŸ  {self.port_name} å·²å®‰å…¨é—œé–‰ã€‚")
        self.is_connected = False

---------------------------------------------
---  END OF FILE: serial_communicator.py  ---
================================================================================

================================================================================
--- START OF FILE: simulation.py ---
------------------------------------

# simulation.py
import mujoco
import glfw
import sys
import numpy as np
from typing import TYPE_CHECKING
import os

from config import AppConfig
from state import SimulationState, TuningParams

if TYPE_CHECKING:
    from rendering import DebugOverlay
    from keyboard_input_handler import KeyboardInputHandler

class Simulation:
    """
    å°è£ MuJoCo æ¨¡æ“¬ã€GLFW è¦–çª—å’Œæ¸²æŸ“é‚è¼¯ã€‚
    æ–°å¢äº†å®Œæ•´çš„æ»‘é¼ è¦–è§’æ§åˆ¶åŠŸèƒ½ã€‚
    """
    def __init__(self, config: AppConfig):
        """åˆå§‹åŒ– MuJoCo æ¨¡å‹ã€è³‡æ–™ã€GLFW è¦–çª—ä»¥åŠæ»‘é¼ æ§åˆ¶ç›¸é—œç‹€æ…‹ã€‚"""
        self.config = config
        
        try:
            with open(config.mujoco_model_file, 'r', encoding='utf-8') as f:
                xml_string = f.read()
            corrected_xml_string = xml_string.replace('meshdir="assets"', 'meshdir="mesh"')
            
            self.model = mujoco.MjModel.from_xml_string(corrected_xml_string)
            print(f"âœ… XML '{config.mujoco_model_file}' å·²è¼‰å…¥ï¼Œä¸¦åœ¨åŸ·è¡Œæ™‚å°‡ meshdir å¾ 'assets' ä¿®æ­£ç‚º 'mesh'ã€‚")
            
            for i in range(self.model.nu):
                self.model.actuator_biastype[i] = mujoco.mjtBias.mjBIAS_AFFINE
            print("âœ… æ‰€æœ‰è‡´å‹•å™¨çš„æ¨¡å¼å·²åœ¨åŸ·è¡Œæ™‚è¢«å¼·åˆ¶è¨­ç‚º AFFINEï¼Œä»¥å•Ÿç”¨ Python ç«¯çš„ PD æ§åˆ¶ã€‚")
            
        except Exception as e:
            sys.exit(f"âŒ éŒ¯èª¤: ç„¡æ³•è¼‰å…¥æˆ–è™•ç† XML æª”æ¡ˆ '{config.mujoco_model_file}': {e}")
            
        self.data = mujoco.MjData(self.model)
        self.model.opt.timestep = config.physics_timestep

        self.torso_id = mujoco.mj_name2id(self.model, mujoco.mjtObj.mjOBJ_BODY, 'torso')
        if self.torso_id == -1:
            sys.exit("âŒ éŒ¯èª¤: åœ¨ XML ä¸­æ‰¾ä¸åˆ°åç‚º 'torso' çš„ bodyã€‚")
        
        home_key_id = mujoco.mj_name2id(self.model, mujoco.mjtObj.mjOBJ_KEY, 'home')
        if home_key_id != -1:
            self.default_pose = self.model.key_qpos[home_key_id][7:].copy()
        else:
            self.default_pose = np.zeros(config.num_motors)
            print("âš ï¸ è­¦å‘Š: åœ¨ XML ä¸­æœªæ‰¾åˆ°åç‚º 'home' çš„ keyframeï¼Œå°‡ä½¿ç”¨é›¶ä½œç‚ºé è¨­å§¿æ…‹ã€‚")

        if not glfw.init(): sys.exit("âŒ éŒ¯èª¤: GLFW åˆå§‹åŒ–å¤±æ•—ã€‚")
        self.window = glfw.create_window(1200, 900, "MuJoCo æ¨¡æ“¬å™¨ (å«æ»‘é¼ æ§åˆ¶)", None, None)
        if not self.window:
            glfw.terminate()
            sys.exit("âŒ éŒ¯èª¤: GLFW è¦–çª—å»ºç«‹å¤±æ•—ã€‚")
        glfw.make_context_current(self.window)
        glfw.swap_interval(1)

        self.mouse_button_left = False
        self.mouse_button_right = False
        self.last_mouse_x = 0
        self.last_mouse_y = 0

        self.cam = mujoco.MjvCamera()
        self.opt = mujoco.MjvOption()
        mujoco.mjv_defaultCamera(self.cam)
        mujoco.mjv_defaultOption(self.opt)
        self.cam.distance, self.cam.elevation, self.cam.azimuth = 2.5, -20, 90
        
        self.scene = mujoco.MjvScene(self.model, maxgeom=10000)
        self.context = mujoco.MjrContext(self.model, mujoco.mjtFontScale.mjFONTSCALE_100)
        
        glfw.set_cursor_pos_callback(self.window, self._mouse_move_callback)
        glfw.set_mouse_button_callback(self.window, self._mouse_button_callback)
        glfw.set_scroll_callback(self.window, self._scroll_callback)

        print("âœ… MuJoCo æ¨¡æ“¬ç’°å¢ƒèˆ‡è¦–çª—åˆå§‹åŒ–å®Œæˆ (å«æ»‘é¼ æ§åˆ¶)ã€‚")

    def _mouse_button_callback(self, window, button, action, mods):
        if button == glfw.MOUSE_BUTTON_LEFT:
            if action == glfw.PRESS:
                self.mouse_button_left = True
                self.last_mouse_x, self.last_mouse_y = glfw.get_cursor_pos(window)
            elif action == glfw.RELEASE:
                self.mouse_button_left = False
        elif button == glfw.MOUSE_BUTTON_RIGHT:
            if action == glfw.PRESS:
                self.mouse_button_right = True
                self.last_mouse_x, self.last_mouse_y = glfw.get_cursor_pos(window)
            elif action == glfw.RELEASE:
                self.mouse_button_right = False

    def _mouse_move_callback(self, window, xpos, ypos):
        if not (self.mouse_button_left or self.mouse_button_right):
            return
        dx = xpos - self.last_mouse_x
        dy = ypos - self.last_mouse_y
        self.last_mouse_x = xpos
        self.last_mouse_y = ypos
        width, height = glfw.get_window_size(window)
        action_type = None
        if self.mouse_button_right: action_type = mujoco.mjtMouse.mjMOUSE_MOVE_H
        elif self.mouse_button_left: action_type = mujoco.mjtMouse.mjMOUSE_ROTATE_H
        if action_type: mujoco.mjv_moveCamera(self.model, action_type, dx / height, dy / height, self.scene, self.cam)

    def _scroll_callback(self, window, xoffset, yoffset):
        mujoco.mjv_moveCamera(self.model, mujoco.mjtMouse.mjMOUSE_ZOOM, 0, -0.05 * yoffset, self.scene, self.cam)

    def register_callbacks(self, keyboard_handler: "KeyboardInputHandler"):
        keyboard_handler.register_callbacks(self.window)

    def reset(self):
        mujoco.mj_resetData(self.model, self.data)
        mujoco.mj_forward(self.model, self.data)
        print("âœ… MuJoCo æ¨¡æ“¬å·²é‡ç½®ã€‚")

    def should_close(self) -> bool:
        return glfw.window_should_close(self.window)
        
    def apply_position_control(self, target_pos: np.ndarray, params: TuningParams):
        self.model.actuator_gainprm[:, 0] = params.kp
        self.model.actuator_biasprm[:, 1] = -params.kp
        self.model.actuator_biasprm[:, 2] = -params.kd
        self.data.ctrl[:] = target_pos
        force_bias = np.full(self.config.num_motors, params.bias)
        self.data.qfrc_applied[6:] = force_bias

    def step(self, state: SimulationState):
        while self.data.time < state.control_timer:
            mujoco.mj_step(self.model, self.data)

    def render(self, state: SimulationState, overlay: "DebugOverlay"):
        if state.control_mode != "SERIAL_MODE":
            if not (self.mouse_button_left or self.mouse_button_right):
                 self.cam.lookat = self.data.body('torso').xpos
        
        viewport = mujoco.MjrRect(0, 0, *glfw.get_framebuffer_size(self.window))
        
        terrain_manager = getattr(state, 'terrain_manager_ref', None)
        if terrain_manager and terrain_manager.needs_scene_update:
            # =========================================================================
            # === ã€æ ¸å¿ƒä¿®å¾©ã€‘èª¿æ› mjr_uploadHField çš„å‰å…©å€‹åƒæ•¸é †åº             ===
            # =========================================================================
            # æ­£ç¢ºé †åº: (model, context, hfield_id)
            mujoco.mjr_uploadHField(self.model, self.context, terrain_manager.hfield_id)
            terrain_manager.needs_scene_update = False
            print("ğŸ”„ åœ°å½¢å¹¾ä½•å·²ä¸Šå‚³è‡³ GPU é€²è¡Œæ¸²æŸ“ã€‚")
            # =========================================================================
        
        if state.control_mode != "SERIAL_MODE":
            mujoco.mjv_updateScene(self.model, self.data, self.opt, None, self.cam, mujoco.mjtCatBit.mjCAT_ALL, self.scene)
            mujoco.mjr_render(viewport, self.scene, self.context)
        
        overlay.render(viewport, self.context, state, self)
        
        glfw.swap_buffers(self.window)
        glfw.poll_events()
        
    def close(self):
        glfw.terminate()

------------------------------------
---  END OF FILE: simulation.py  ---
================================================================================

================================================================================
--- START OF FILE: state.py ---
-------------------------------

# state.py
from __future__ import annotations
import numpy as np
from dataclasses import dataclass, field
from config import AppConfig
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from floating_controller import FloatingController
    from policy import ONNXPolicy
    from hardware_controller import HardwareController # <-- æ–°å¢

@dataclass
class TuningParams:
    """ç”¨æ–¼å³æ™‚èª¿æ•´æ©Ÿå™¨äººæ§åˆ¶åƒæ•¸çš„é¡åˆ¥ã€‚"""
    kp: float
    kd: float
    action_scale: float
    bias: float

@dataclass
class SimulationState:
    """ç®¡ç†æ‰€æœ‰æ¨¡æ“¬ä¸­å‹•æ…‹è®ŠåŒ–çš„ç‹€æ…‹ï¼Œå–ä»£ global è®Šæ•¸ã€‚"""
    config: AppConfig
    command: np.ndarray = field(default_factory=lambda: np.zeros(3, dtype=np.float32))
    tuning_params: TuningParams = field(init=False)
    
    hard_reset_requested: bool = False
    soft_reset_requested: bool = False

    control_timer: float = 0.0
    
    sim_mode_text: str = "Initializing"
    input_mode: str = "KEYBOARD"
    control_mode: str = "WALKING" # "WALKING", "FLOATING", "HARDWARE_MODE", etc.

    latest_onnx_input: np.ndarray = field(default_factory=lambda: np.array([]))
    latest_action_raw: np.ndarray = field(default_factory=lambda: np.zeros(12))
    latest_final_ctrl: np.ndarray = field(default_factory=lambda: np.zeros(12))
    latest_pos: np.ndarray = field(default_factory=lambda: np.zeros(3))
    latest_quat: np.ndarray = field(default_factory=lambda: np.array([1., 0., 0., 0.]))
    display_page: int = 0
    num_display_pages: int = 2

    serial_command_buffer: str = ""
    serial_command_to_send: str = ""
    serial_latest_messages: list = field(default_factory=list)

    joint_test_index: int = 0
    joint_test_offsets: np.ndarray = field(default_factory=lambda: np.zeros(12))

    manual_ctrl_index: int = 0
    manual_final_ctrl: np.ndarray = field(default_factory=lambda: np.zeros(12))
    manual_mode_is_floating: bool = False

    serial_is_connected: bool = False
    gamepad_is_connected: bool = False

    tuning_param_index: int = 0

    floating_controller_ref: 'FloatingController' = None
    policy_ref: 'ONNXPolicy' = None
    
    # --- æ–°å¢ç¡¬é«”æ¨¡å¼ç›¸é—œç‹€æ…‹ ---
    hardware_controller_ref: 'HardwareController' = None # ç¡¬é«”æ§åˆ¶å™¨ç‰©ä»¶çš„åƒè€ƒ
    hardware_is_connected: bool = False
    hardware_ai_is_active: bool = False
    hardware_status_text: str = "æœªé€£æ¥"

    single_step_mode: bool = False
    execute_one_step: bool = False

    def __post_init__(self):
        """åœ¨åˆå§‹åŒ–å¾Œï¼Œæ ¹æ“šè¨­å®šæª”è¨­å®šåˆå§‹å€¼ã€‚"""
        self.tuning_params = TuningParams(**self.config.initial_tuning_params.__dict__)
        self.latest_action_raw = np.zeros(self.config.num_motors)
        self.latest_final_ctrl = np.zeros(self.config.num_motors)
        self.manual_final_ctrl = np.zeros(self.config.num_motors)
        print("âœ… SimulationState åˆå§‹åŒ–å®Œæˆã€‚")

    def reset_control_state(self, sim_time: float):
        self.control_timer = sim_time
        print("âœ… æ§åˆ¶ç‹€æ…‹å·²é‡ç½®ã€‚")

    def clear_command(self):
        self.command.fill(0.0)
        print("é‹å‹•æŒ‡ä»¤å·²æ¸…é™¤ã€‚")

    def toggle_input_mode(self, new_mode: str):
        if self.input_mode != new_mode:
            self.input_mode = new_mode
            self.clear_command()
            print(f"è¼¸å…¥æ¨¡å¼å·²åˆ‡æ›è‡³: {self.input_mode}")
            
    def set_control_mode(self, new_mode: str):
        """åˆ‡æ›ä¸»æ§åˆ¶æ¨¡å¼ï¼Œä¸¦å‘¼å«å°æ‡‰çš„å•Ÿç”¨/ç¦ç”¨å‡½å¼ã€‚"""
        if self.control_mode == new_mode: return

        old_mode = self.control_mode
        
        # --- é›¢é–‹èˆŠæ¨¡å¼æ™‚çš„æ¸…ç†å·¥ä½œ ---
        if old_mode == "FLOATING":
            if self.floating_controller_ref: self.floating_controller_ref.disable()
        elif old_mode == "MANUAL_CTRL" and self.manual_mode_is_floating:
             if self.floating_controller_ref: self.floating_controller_ref.disable()
             self.manual_mode_is_floating = False
        # --- æ–°å¢ï¼šé›¢é–‹ç¡¬é«”æ¨¡å¼æ™‚çš„æ¸…ç†å·¥ä½œ ---
        elif old_mode == "HARDWARE_MODE":
            if self.hardware_controller_ref:
                self.hardware_controller_ref.stop()
            self.hardware_is_connected = False
            self.hardware_ai_is_active = False
            
        self.control_mode = new_mode
        print(f"æ§åˆ¶æ¨¡å¼å·²åˆ‡æ›è‡³: {self.control_mode}")

        # --- é€²å…¥æ–°æ¨¡å¼æ™‚çš„è¨­å®šå·¥ä½œ ---
        if new_mode == "FLOATING":
            if self.floating_controller_ref: self.floating_controller_ref.enable(self.latest_pos)
        elif new_mode == "JOINT_TEST":
            self.joint_test_offsets.fill(0.0)
        elif new_mode == "MANUAL_CTRL":
            self.manual_final_ctrl[:] = self.latest_final_ctrl
        # --- æ–°å¢ï¼šé€²å…¥ç¡¬é«”æ¨¡å¼æ™‚çš„è¨­å®šå·¥ä½œ ---
        elif new_mode == "HARDWARE_MODE":
             if self.hardware_controller_ref and self.hardware_controller_ref.connect_and_start():
                 self.hardware_is_connected = True
             else:
                 print("âŒ ç¡¬é«”é€£æ¥å¤±æ•—ï¼Œè‡ªå‹•è¿”å› WALKING æ¨¡å¼ã€‚")
                 # å› ç‚ºé€£æ¥å¤±æ•—ï¼Œæˆ‘å€‘éœ€è¦å°‡ control_mode è¨­å›èˆŠçš„æ¨¡å¼ï¼Œæˆ–è€…ä¸€å€‹å®‰å…¨æ¨¡å¼
                 # æ³¨æ„ï¼šç›´æ¥åœ¨é€™è£¡å†æ¬¡ä¿®æ”¹ self.control_mode å¯èƒ½æœƒå°è‡´ç„¡é™éè¿´
                 # æœ€å¥½æ˜¯åœ¨å‘¼å«ç«¯è™•ç†é€™ç¨®å¤±æ•—æƒ…æ³ï¼Œä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘åœ¨é€™è£¡ç›´æ¥è¨­å®š
                 self.control_mode = "WALKING" 
                 print(f"æ§åˆ¶æ¨¡å¼å·²è‡ªå‹•åˆ‡æ›è‡³: {self.control_mode}")


        # --- ã€æ ¸å¿ƒã€‘æ¨¡å¼åˆ‡æ›ç©©å®šæ€§ä¿®å¾© ---
        # å¦‚æœæ˜¯å¾æ‰‹å‹•æ¨¡å¼åˆ‡æ›å› AI æ¨¡å¼
        is_entering_ai_mode = new_mode in ["WALKING", "FLOATING"]
        is_leaving_manual_mode = old_mode in ["JOINT_TEST", "MANUAL_CTRL"]
        
        if is_entering_ai_mode and is_leaving_manual_mode:
            print("å¾æ‰‹å‹•æ¨¡å¼è¿”å›ï¼Œæ­£åœ¨é‡ç½® AI ç‹€æ…‹ä»¥ç¢ºä¿å¹³æ»‘éæ¸¡...")
            if self.policy_ref:
                self.policy_ref.reset()
            self.clear_command()

-------------------------------
---  END OF FILE: state.py  ---
================================================================================

================================================================================
--- START OF FILE: terrain_manager.py ---
-----------------------------------------

# terrain_manager.py
import mujoco
import numpy as np

class TerrainManager:
    """
    ç®¡ç†å’Œå‹•æ…‹åˆ‡æ› MuJoCo é«˜åº¦å ´ (hfield) åœ°å½¢ã€‚
    """
    def __init__(self, model, data):
        self.model = model # å„²å­˜ MuJoCo æ¨¡å‹ç‰©ä»¶
        self.data = data # å„²å­˜ MuJoCo è³‡æ–™ç‰©ä»¶
        self.hfield_id = mujoco.mj_name2id(model, mujoco.mjtObj.mjOBJ_HFIELD, 'terrain') # æ ¹æ“šåç¨± 'terrain' ç²å–é«˜åº¦å ´çš„ ID
        
        self.needs_scene_update = False # æ¨™è¨˜æ˜¯å¦éœ€è¦æ›´æ–°æ¸²æŸ“å ´æ™¯
        
        if self.hfield_id == -1: # æª¢æŸ¥æ˜¯å¦æˆåŠŸæ‰¾åˆ°é«˜åº¦å ´
            print("âŒ éŒ¯èª¤: åœ¨ XML ä¸­æ‰¾ä¸åˆ°åç‚º 'terrain' çš„ hfieldã€‚åœ°å½¢åˆ‡æ›åŠŸèƒ½å°‡è¢«ç¦ç”¨ã€‚")
            self.is_functional = False # è‹¥æ‰¾ä¸åˆ°ï¼Œå‰‡ç¦ç”¨æ­¤åŠŸèƒ½
            return

        self.nrow = model.hfield_nrow[self.hfield_id] # å¾æ¨¡å‹ä¸­ç²å–é«˜åº¦å ´çš„è¡Œæ•¸
        self.ncol = model.hfield_ncol[self.hfield_id] # å¾æ¨¡å‹ä¸­ç²å–é«˜åº¦å ´çš„åˆ—æ•¸
        self.size = model.hfield_size[self.hfield_id] # å¾æ¨¡å‹ä¸­ç²å–é«˜åº¦å ´çš„ç‰©ç†å°ºå¯¸
        self.adr = model.hfield_adr[self.hfield_id] # å¾æ¨¡å‹ä¸­ç²å–é«˜åº¦å ´è³‡æ–™åœ¨ mjModel.hfield_data ä¸­çš„èµ·å§‹ä½å€
        
        # ã€ä¿®æ”¹ã€‘åœ¨åœ°å½¢å­—å…¸ä¸­åŠ å…¥æ–°çš„é‡‘å­—å¡”åœ°å½¢
        self.terrains = {
            "Flat": self.generate_flat,
            "Sine Waves": self.generate_sine_waves,
            "Steps": self.generate_steps,
            "Random Noise": self.generate_random_noise,
            "Pyramid": self.generate_pyramid, # <-- æ–°å¢é‡‘å­—å¡”åœ°å½¢
        }
        self.terrain_names = list(self.terrains.keys()) # ç²å–æ‰€æœ‰åœ°å½¢çš„åç¨±åˆ—è¡¨
        self.current_terrain_index = 0 # å°‡ç›®å‰åœ°å½¢ç´¢å¼•åˆå§‹åŒ–ç‚º 0
        self.is_functional = True # æ¨™è¨˜åŠŸèƒ½ç‚ºå¯ç”¨
        
        self.switch_terrain(0) # åˆå§‹åŒ–æ™‚ï¼Œåˆ‡æ›åˆ°ç¬¬ä¸€å€‹åœ°å½¢ï¼ˆå¹³åœ°ï¼‰
        print("âœ… åœ°å½¢ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ (ä½¿ç”¨é«˜åº¦å ´)ã€‚")

    def generate_flat(self):
        """ç”Ÿæˆä¸€å€‹å®Œå…¨å¹³å¦çš„åœ°å½¢ã€‚"""
        return np.zeros((self.nrow, self.ncol)) # å›å‚³ä¸€å€‹å…¨ç‚º 0 çš„äºŒç¶­é™£åˆ—

    def generate_sine_waves(self):
        """ç”Ÿæˆç”±æ­£å¼¦æ³¢çµ„æˆçš„æ³¢æµªç‹€åœ°å½¢ã€‚"""
        x = np.linspace(0, 2 * np.pi, self.ncol) # å»ºç«‹ x è»¸åº§æ¨™
        y = np.linspace(0, 2 * np.pi, self.nrow) # å»ºç«‹ y è»¸åº§æ¨™
        X, Y = np.meshgrid(x, y) # å»ºç«‹äºŒç¶­ç¶²æ ¼
        return 0.05 * (np.sin(X * 3) + np.sin(Y * 2)) # è¨ˆç®—æ¯å€‹é»çš„é«˜åº¦

    def generate_steps(self):
        """ç”Ÿæˆéšæ¢¯ç‹€åœ°å½¢ã€‚"""
        hfield = np.zeros((self.nrow, self.ncol)) # åˆå§‹åŒ–ç‚ºå¹³åœ°
        step_height = 0.03 # è¨­å®šæ¯å€‹éšæ¢¯çš„é«˜åº¦
        step_width = self.nrow // 10 # è¨­å®šæ¯å€‹éšæ¢¯çš„å¯¬åº¦
        for i in range(10): # å¾ªç’°ç”Ÿæˆ 10 å€‹éšæ¢¯
            hfield[i*step_width:(i+1)*step_width, :] = i * step_height
        return hfield # å›å‚³éšæ¢¯åœ°å½¢è³‡æ–™

    def generate_random_noise(self):
        """ç”Ÿæˆéš¨æ©Ÿçš„å´å¶‡åœ°å½¢ã€‚"""
        return np.random.rand(self.nrow, self.ncol) * 0.05 # ç”Ÿæˆ 0 åˆ° 0.05 ä¹‹é–“çš„éš¨æ©Ÿé«˜åº¦

    # ã€æ–°å¢ã€‘ç”Ÿæˆé‡‘å­—å¡”åœ°å½¢çš„å‡½å¼
    def generate_pyramid(self):
        """ç”Ÿæˆä¸€å€‹ä¸­å¤®é«˜ã€å››å‘¨ä½çš„æ­£é‡‘å­—å¡”åœ°å½¢ã€‚"""
        max_height = 1.0  # è¨­å®šé‡‘å­—å¡”çš„æœ€é«˜é»é«˜åº¦ï¼ˆå–®ä½ï¼šç±³ï¼‰
        
        # å»ºç«‹å¾ -1 åˆ° 1 çš„æ¨™æº–åŒ–åº§æ¨™ç³»ï¼Œé€™æ¨£ä¸­å¿ƒé»å°±æ˜¯ (0,0)
        x = np.linspace(-1, 1, self.ncol)
        y = np.linspace(-1, 1, self.nrow)
        # ä½¿ç”¨ meshgrid ç”¢ç”ŸäºŒç¶­åº§æ¨™ç¶²æ ¼
        X, Y = np.meshgrid(x, y)
        
        # è¨ˆç®—æ¯å€‹é»åˆ°ä¸­å¿ƒçš„åˆ‡æ¯”é›ªå¤«è·é›¢ (Chebyshev distance)ï¼Œå³ max(|dx|, |dy|)
        # é€™æœƒå½¢æˆä¸€å€‹æ–¹å½¢çš„ç­‰é«˜ç·šï¼Œæ­£å¥½æ˜¯é‡‘å­—å¡”çš„å½¢ç‹€
        dist = np.maximum(np.abs(X), np.abs(Y))
        
        # é«˜åº¦ = æœ€é«˜é«˜åº¦ * (1 - è·é›¢)
        # åœ¨ä¸­å¿ƒé» (dist=0)ï¼Œé«˜åº¦ç‚º max_height
        # åœ¨é‚Šç•Œ (dist=1)ï¼Œé«˜åº¦ç‚º 0
        hfield_data = max_height * (1 - dist)
        
        return hfield_data # å›å‚³é‡‘å­—å¡”é«˜åº¦å ´è³‡æ–™

    def cycle_terrain(self):
        """å¾ªç’°åˆ‡æ›åˆ°ä¸‹ä¸€å€‹åœ°å½¢ã€‚"""
        if not self.is_functional: return # å¦‚æœåŠŸèƒ½æœªå•Ÿç”¨ï¼Œç›´æ¥è¿”å›
        self.current_terrain_index = (self.current_terrain_index + 1) % len(self.terrain_names) # è¨ˆç®—ä¸‹ä¸€å€‹åœ°å½¢çš„ç´¢å¼•
        self.switch_terrain(self.current_terrain_index) # åˆ‡æ›åˆ°è©²åœ°å½¢

    def get_current_terrain_name(self):
        """ç²å–ç›®å‰åœ°å½¢çš„åç¨±ã€‚"""
        if not self.is_functional: return "N/A (hfield missing)" # å¦‚æœåŠŸèƒ½æœªå•Ÿç”¨ï¼Œè¿”å›æç¤ºè¨Šæ¯
        return self.terrain_names[self.current_terrain_index] # è¿”å›ç›®å‰åœ°å½¢çš„åç¨±

    def switch_terrain(self, index):
        """åˆ‡æ›åˆ°æŒ‡å®šç´¢å¼•çš„åœ°å½¢ã€‚"""
        if not self.is_functional: return # å¦‚æœåŠŸèƒ½æœªå•Ÿç”¨ï¼Œç›´æ¥è¿”å›
        
        terrain_name = self.terrain_names[index] # ç²å–åœ°å½¢åç¨±
        print(f"ğŸï¸ åˆ‡æ›åœ°å½¢è‡³: {terrain_name}") # åœ¨æ§åˆ¶å°è¼¸å‡ºæç¤º
        
        generator = self.terrains[terrain_name] # æ ¹æ“šåç¨±ç²å–å°æ‡‰çš„ç”Ÿæˆå‡½å¼
        hfield_data = generator() # å‘¼å«ç”Ÿæˆå‡½å¼ï¼Œç”¢ç”Ÿé«˜åº¦è³‡æ–™
        
        # å°‡æ–°ç”Ÿæˆçš„é«˜åº¦è³‡æ–™å¯«å…¥ MuJoCo æ¨¡å‹çš„é«˜åº¦å ´è³‡æ–™ç·©è¡å€
        self.model.hfield_data[self.adr:self.adr + self.nrow*self.ncol] = hfield_data.flatten()
        
        self.needs_scene_update = True # è¨­å®šæ¨™è¨˜ï¼Œé€šçŸ¥æ¸²æŸ“è¿´åœˆéœ€è¦æ›´æ–°å ´æ™¯

-----------------------------------------
---  END OF FILE: terrain_manager.py  ---
================================================================================

================================================================================
--- START OF FILE: xbox_controller.py ---
-----------------------------------------

# xbox_controller.py
import pygame

class XboxController:
    """
    ä¸€å€‹ä½¿ç”¨ Pygame å‡½å¼åº«ä¾†è®€å– Xbox æ–æ¡¿è¼¸å…¥çš„é¡åˆ¥ã€‚
    é€™å€‹ç‰ˆæœ¬æ˜¯éé˜»å¡çš„ï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨ä¸»è¿´åœˆä¸­æ›´æ–°ã€‚
    """
    def __init__(self):
        """åˆå§‹åŒ– Pygame ä½†ä¸ç«‹å³æƒææ–æ¡¿ã€‚"""
        pygame.init()
        self.joystick = None
        self.deadzone = 0.15
        self.state = {
            'left_analog_x': 0.0, 'left_analog_y': 0.0,
            'right_analog_x': 0.0, 'right_analog_y': 0.0,
            'dpad': (0, 0),
            'button_a': 0, 'button_b': 0, 'button_x': 0, 'button_y': 0,
            'button_l1': 0, 'button_r1': 0,
            'button_select': 0, 'button_start': 0,
        }
        print("âœ… XBox æ§åˆ¶å™¨å·²åˆå§‹åŒ– (ç­‰å¾…é€£æ¥æŒ‡ä»¤)ã€‚")

    def scan_and_connect(self) -> bool:
        """æƒæä¸¦é€£æ¥åˆ°ç¬¬ä¸€å€‹å¯ç”¨çš„æ–æ¡¿ã€‚"""
        if self.is_connected():
            print("æ–æ¡¿å·²é€£æ¥ï¼Œç„¡éœ€é‡æ–°æƒæã€‚")
            return True

        print("\n" + "="*20 + " æ­£åœ¨æƒææ–æ¡¿ " + "="*20)
        pygame.joystick.init() # æ¯æ¬¡æƒææ™‚é‡æ–°åˆå§‹åŒ–
        
        if pygame.joystick.get_count() > 0:
            self.joystick = pygame.joystick.Joystick(0)
            self.joystick.init()
            print(f"âœ… æˆåŠŸé€£æ¥åˆ°æ–æ¡¿: {self.joystick.get_name()}")
            return True
        else:
            print("--- æœªåµæ¸¬åˆ°ä»»ä½•æ–æ¡¿ ---")
            self.joystick = None
            return False

    def is_connected(self) -> bool:
        """æª¢æŸ¥æ–æ¡¿æ˜¯å¦å·²æˆåŠŸåˆå§‹åŒ–ã€‚"""
        return self.joystick is not None

    def update(self):
        """è™•ç† Pygame äº‹ä»¶ä½‡åˆ—ï¼Œæ›´æ–°æ–æ¡¿ç‹€æ…‹ã€‚"""
        if not self.is_connected():
            return
            
        for event in pygame.event.get():
            if event.type == pygame.JOYAXISMOTION:
                if event.axis == 0: self.state['left_analog_x'] = event.value
                elif event.axis == 1: self.state['left_analog_y'] = event.value
                elif event.axis == 2: self.state['right_analog_x'] = event.value
                elif event.axis == 3: self.state['right_analog_y'] = event.value
            elif event.type == pygame.JOYBUTTONDOWN:
                if event.button == 0: self.state['button_a'] = 1
                elif event.button == 1: self.state['button_b'] = 1
                elif event.button == 2: self.state['button_x'] = 1
                elif event.button == 3: self.state['button_y'] = 1
                elif event.button == 4: self.state['button_l1'] = 1
                elif event.button == 5: self.state['button_r1'] = 1
                elif event.button == 6: self.state['button_select'] = 1
                elif event.button == 7: self.state['button_start'] = 1
            elif event.type == pygame.JOYBUTTONUP:
                if event.button == 0: self.state['button_a'] = 0
                elif event.button == 1: self.state['button_b'] = 0
                elif event.button == 2: self.state['button_x'] = 0
                elif event.button == 3: self.state['button_y'] = 0
                elif event.button == 4: self.state['button_l1'] = 0
                elif event.button == 5: self.state['button_r1'] = 0
                elif event.button == 6: self.state['button_select'] = 0
                elif event.button == 7: self.state['button_start'] = 0
            elif event.type == pygame.JOYHATMOTION:
                self.state['dpad'] = event.value

    def get_input(self) -> dict:
        """ç²å–ç•¶å‰æ–æ¡¿ç‹€æ…‹çš„æ·ºæ‹·è²ï¼Œä¸¦æ‡‰ç”¨æ­»å€ã€‚"""
        for axis in ['left_analog_x', 'left_analog_y', 'right_analog_x', 'right_analog_y']:
            if abs(self.state[axis]) < self.deadzone:
                self.state[axis] = 0.0
        return self.state.copy()

    def close(self):
        """é—œé–‰ Pygameã€‚"""
        pygame.quit()

-----------------------------------------
---  END OF FILE: xbox_controller.py  ---
================================================================================

================================================================================
--- START OF FILE: xbox_input_handler.py ---
--------------------------------------------

# xbox_input_handler.py
from state import SimulationState
from xbox_controller import XboxController

class XboxInputHandler:
    """
    è™•ç† Xbox æ–æ¡¿çš„è¼¸å…¥ï¼Œä¸¦å°‡å…¶è½‰æ›ç‚ºå° SimulationState çš„æ›´æ–°ã€‚
    """
    def __init__(self, state: SimulationState):
        """åˆå§‹åŒ– XboxInputHandlerã€‚"""
        self.state = state
        self.config = state.config
        self.controller = XboxController()
        self.last_input_state = {}
        self.param_keys = ['kp', 'kd', 'action_scale', 'bias']
        self.num_params = len(self.param_keys)
    
    def scan_and_connect(self) -> bool:
        """å‘¼å«åº•å±¤æ§åˆ¶å™¨é€²è¡Œæƒæå’Œé€£æ¥ã€‚"""
        is_success = self.controller.scan_and_connect()
        if is_success:
            self.state.toggle_input_mode("GAMEPAD")
        return is_success

    def is_available(self) -> bool:
        """æª¢æŸ¥æ–æ¡¿æ˜¯å¦å·²æˆåŠŸåˆå§‹åŒ–ä¸¦é€£æ¥ã€‚"""
        return self.controller.is_connected()

    def update_state(self):
        """å¾æ–æ¡¿è®€å–è¼¸å…¥ä¸¦æ›´æ–° SimulationStateã€‚"""
        if not self.is_available():
            if self.state.input_mode == "GAMEPAD":
                print("ğŸ® æ–æ¡¿å·²æ–·é–‹ï¼Œè‡ªå‹•åˆ‡æ›å›éµç›¤æ¨¡å¼ã€‚")
                self.state.toggle_input_mode("KEYBOARD")
                self.state.gamepad_is_connected = False
            return

        self.controller.update() 
        current_input = self.controller.get_input()
        
        self.state.command[0] = current_input['left_analog_x'] * self.config.gamepad_sensitivity['vy']
        self.state.command[1] = current_input['left_analog_y'] * self.config.gamepad_sensitivity['vx'] * -1
        self.state.command[2] = current_input['right_analog_x'] * self.config.gamepad_sensitivity['wz']

        if current_input['button_select'] and not self.last_input_state.get('button_select', 0):
            self.state.hard_reset_requested = True
            
        if current_input['button_l1'] and not self.last_input_state.get('button_l1', 0):
            self.state.tuning_param_index = (self.state.tuning_param_index - 1) % self.num_params
        
        if current_input['button_r1'] and not self.last_input_state.get('button_r1', 0):
            self.state.tuning_param_index = (self.state.tuning_param_index + 1) % self.num_params

        dpad_y = current_input['dpad'][1]
        last_dpad_y = self.last_input_state.get('dpad', (0,0))[1]

        if dpad_y != last_dpad_y:
            param_to_adjust = self.param_keys[self.state.tuning_param_index]
            step = self.config.param_adjust_steps.get(param_to_adjust, 0.1)
            current_value = getattr(self.state.tuning_params, param_to_adjust)

            if dpad_y == 1:
                setattr(self.state.tuning_params, param_to_adjust, current_value + step)
            elif dpad_y == -1:
                setattr(self.state.tuning_params, param_to_adjust, current_value - step)
        
        self.last_input_state = current_input
        
        self.state.tuning_params.kp = max(0, self.state.tuning_params.kp)
        self.state.tuning_params.kd = max(0, self.state.tuning_params.kd)
        self.state.tuning_params.action_scale = max(0, self.state.tuning_params.action_scale)

    def close(self):
        """é—œé–‰æ–æ¡¿é€£æ¥ã€‚"""
        if self.controller:
            self.controller.close()

--------------------------------------------
---  END OF FILE: xbox_input_handler.py  ---
================================================================================

================================================================================
--- START OF FILE: assets/pupper.xml ---
----------------------------------------

<!-- 
  Pupper Model - Final Corrected Version
-->
<mujoco model="pupper_env">
    <compiler angle="radian" autolimits="true"/>

    <option timestep="0.001" gravity="0 0 -9.81" 
            iterations="5" ls_iterations="10" noslip_iterations="2">
        <flag eulerdamp="disable"/>
    </option>

    <default>
        <default class="pupper">
            <joint armature="0.01" damping="0.5239" solimplimit="0.9 0.99 0.001" solreflimit="0.02 1"/>
            <geom type="mesh" contype="0" conaffinity="0" rgba="0.8 0.6 .4 1"/>
            <general biastype="affine" gainprm="35.0 0 0" biasprm="0 -35.0 0"/>
            <default class="pupper/collision/foot">
                <geom type="sphere" 
                      contype="1" conaffinity="1" 
                      group="3"
                      friction="1.0 0.2 0.1" 
                      solimp="0.9 0.99 0.001" 
                      solref="0.02 1"
                      rgba="1 0 0 1"/>
            </default>
        </default>
    </default>

    <asset>
        <mesh name="body" file="mesh/body.stl" scale="0.001 0.001 0.001"/>
        <mesh name="Hip_L" file="mesh/Hip_L.stl" scale="0.001 0.001 0.001"/>
        <mesh name="Hip_R" file="mesh/Hip_R.stl" scale="0.001 0.001 0.001"/>
        <mesh name="Upper_Leg_L" file="mesh/Upper_Leg_L.stl" scale="0.001 0.001 0.001"/>
        <mesh name="Upper_Leg_R" file="mesh/Upper_Leg_R.stl" scale="0.001 0.001 0.001"/>
        <mesh name="Lower_Leg_L" file="mesh/Lower_Leg_L.stl" scale="0.001 0.001 0.001"/>
        <mesh name="Lower_Leg_R" file="mesh/Lower_Leg_R.stl" scale="0.001 0.001 0.001"/>
    </asset>

    <worldbody>
        <body name="torso" pos="0 0 0.2" childclass="pupper">
            <freejoint name="root"/>
            <camera name="track" pos="1.958 -2.348 0.591" xyaxes="0.768 0.641 0.000 -0.101 0.122 0.987" mode="trackcom"/>
            <inertial pos="0.00109 -0.074 0" mass="0.7833" diaginertia="0.0003688 0.002508 0.002674"/>
            <geom name="torso_geom" mesh="body"/>
            <site name="imu_frame" pos="0 0 0" size="0.01" type="sphere" rgba="1 0 0 0.5"/>

            <!-- ==================== Front-Right Leg ==================== -->
            <body name="leg_front_right" pos="-0.046891 -0.203946 -0.0064">
                <inertial pos="0 0 0" mass="0.1081" diaginertia="3.698e-05 7.127e-06 4.075e-05"/>
                <joint name="abduction_front_right" type="hinge" axis="0 1 0" pos="0 0 0" range="-1.0472 1.0472"/>
                <geom name="fr_block_geom" mesh="Hip_R"/>
                <body name="upper_leg_front_right" pos="-0.037 0.028 0" axisangle="1 0 0 0.7854">
                    <inertial pos="0 0 0" mass="0.1321" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                    <joint name="hip_front_right" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.76166 3.81442"/>
                    <geom name="fr_geom" mesh="Upper_Leg_R"/>
                    <body name="lower_leg_front_right" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
                        <inertial pos="0 0 0" mass="0.1036" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                        <joint name="knee_front_right" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.78540 1.65806"/>
                        <geom name="fr_l2_geom" mesh="Lower_Leg_R"/>
                        
                        <!-- FINAL FIX: å°‡ site çš„åå­—æ”¹å› "foot_front_right"ï¼Œä»¥åŒ¹é… Python ç’°å¢ƒçš„éœ€æ±‚ã€‚-->
                        <site name="foot_front_right" pos="0.003475 0 -0.11" size="0.009525" type="sphere" rgba="0 1 0 0.5"/>
                        <geom name="foot_front_right_collision" class="pupper/collision/foot" 
                              pos="0.003475 0 -0.11" size="0.009525"/>
                    </body>
                </body>
            </body>
            
            <!-- ==================== Front-Left Leg ==================== -->
            <body name="leg_front_left" pos="0.047109 -0.203946 -0.0064">
                <inertial pos="0 0 0" mass="0.1081" diaginertia="3.698e-05 7.127e-06 4.075e-05"/>
                <joint name="abduction_front_left" type="hinge" axis="0 1 0" pos="0 0 0" range="-1.0472 1.0472"/>
                <geom name="fl_block_geom" mesh="Hip_L"/>
                <body name="upper_leg_front_left" pos="0.037 0.028 0" axisangle="1 0 0 0.7854">
                    <inertial pos="0 0 0" mass="0.1321" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                    <joint name="hip_front_left" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.76166 3.81442"/>
                    <geom name="fl_geom" mesh="Upper_Leg_L"/>
                    <body name="lower_leg_front_left" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
                        <inertial pos="0 0 0" mass="0.1036" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                        <joint name="knee_front_left" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.78540 1.65806"/>
                        <geom name="fl_l2_geom" mesh="Lower_Leg_L"/>
                        <site name="foot_front_left" pos="-0.003475 0 -0.11" size="0.009525" type="sphere" rgba="0 1 0 0.5"/>
                        <geom name="foot_front_left_collision" class="pupper/collision/foot" 
                              pos="-0.003475 0 -0.11" size="0.009525"/>
                    </body>
                </body>
            </body>
            
            <!-- ==================== Hind-Right Leg ==================== -->
            <body name="leg_hind_right" pos="-0.046896 -0.004096 -0.0064">
                <inertial pos="0 0 0" mass="0.1081" diaginertia="3.698e-05 7.127e-06 4.075e-05"/>
                <joint name="abduction_hind_right" type="hinge" axis="0 1 0" pos="0 0 0" range="-1.0472 1.0472"/>
                <geom name="br_block_geom" mesh="Hip_R"/>
                <body name="upper_leg_hind_right" pos="-0.037 0.028 0" axisangle="1 0 0 0.7854">
                    <inertial pos="0 0 0" mass="0.1321" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                    <joint name="hip_hind_right" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.76166 3.81442"/>
                    <geom name="br_geom" mesh="Upper_Leg_R"/>
                    <body name="lower_leg_hind_right" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
                        <inertial pos="0 0 0" mass="0.1036" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                        <joint name="knee_hind_right" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.78540 1.65806"/>
                        <geom name="br_l2_geom" mesh="Lower_Leg_R"/>
                        <site name="foot_hind_right" pos="0.003475 0 -0.11" size="0.009525" type="sphere" rgba="0 1 0 0.5"/>
                        <geom name="foot_hind_right_collision" class="pupper/collision/foot" 
                              pos="0.003475 0 -0.11" size="0.009525"/>
                    </body>
                </body>
            </body>
            
            <!-- ==================== Hind-Left Leg ==================== -->
            <body name="leg_hind_left" pos="0.047104 -0.004096 -0.0064">
                <inertial pos="0 0 0" mass="0.1081" diaginertia="3.698e-05 7.127e-06 4.075e-05"/>
                <joint name="abduction_hind_left" type="hinge" axis="0 1 0" pos="0 0 0" range="-1.0472 1.0472"/>
                <geom name="bl_block_geom" mesh="Hip_L"/>
                <body name="upper_leg_hind_left" pos="0.037 0.028 0" axisangle="1 0 0 0.7854">
                    <inertial pos="0 0 0" mass="0.1321" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                    <joint name="hip_hind_left" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.76166 3.81442"/>
                    <geom name="bl_geom" mesh="Upper_Leg_L"/>
                    <body name="lower_leg_hind_left" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
                        <inertial pos="0 0 0" mass="0.1036" diaginertia="0.0002253 6.493e-05 0.0002502"/>
                        <joint name="knee_hind_left" type="hinge" axis="1 0 0" pos="0 0 0" range="-0.78540 1.65806"/>
                        <geom name="bl_l2_geom" mesh="Lower_Leg_L"/>
                        <site name="foot_hind_left" pos="-0.003475 0 -0.11" size="0.009525" type="sphere" rgba="0 1 0 0.5"/>
                        <geom name="foot_hind_left_collision" class="pupper/collision/foot" 
                              pos="-0.003475 0 -0.11" size="0.009525"/>
                    </body>
                </body>
            </body>
        </body>
    </worldbody>

    <actuator>
        <general class="pupper" joint="abduction_front_right"/>
        <general class="pupper" joint="hip_front_right"/>
        <general class="pupper" joint="knee_front_right"/>
        <general class="pupper" joint="abduction_front_left"/>
        <general class="pupper" joint="hip_front_left"/>
        <general class="pupper" joint="knee_front_left"/>
        <general class="pupper" joint="abduction_hind_right"/>
        <general class="pupper" joint="hip_hind_right"/>
        <general class="pupper" joint="knee_hind_right"/>
        <general class="pupper" joint="abduction_hind_left"/>
        <general class="pupper" joint="hip_hind_left"/>
        <general class="pupper" joint="knee_hind_left"/>
    </actuator>
    
    <sensor>
        <!-- Sensor section remains unchanged -->
    </sensor>

    <keyframe>
        <key name="home"
            qpos="0 0 0.2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"
            ctrl="0 0 0 0 0 0 0 0 0 0 0 0" />
    </keyframe>
</mujoco>

----------------------------------------
---  END OF FILE: assets/pupper.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/pupper_mjx.xml ---
--------------------------------------------

<!-- =================================================================
     Pupper Model - Final Version with Global PD(Kp, Kv) Settings
     ================================================================= -->
<mujoco model="pupper_global_pd">
  <compiler angle="radian" meshdir="assets/mesh" autolimits="true"/> <!-- assets to assets/mesh -->
  <option iterations="1" ls_iterations="5" timestep="0.004" integrator="Euler">
    <flag eulerdamp="disable"/>
  </option>
  <custom>
    <numeric data="30" name="max_contact_points"/>
    <numeric data="12" name="max_geom_pairs"/>
  </custom>

  <!-- [MODIFIED] All physical and control parameters are now globally defined here -->
  <default>
    <default class="pupper">
      <!-- 1. Global physical properties for ALL joints -->
      <joint armature="0.005" damping="0.1" frictionloss="0.2"/>
      
      <!-- 2. Global controller template for ALL position actuators -->
      <!--    kp and kv are placeholders to be modified by the Python script -->
      <general gainprm="0.333" ctrlrange="-5.0 5.0" gear="1" biastype="none"/>


      <!-- Joint-specific kinematics -->
      <default class="abduction">
        <joint axis="0 1 0" range="-1.0472 1.0472"/>
      </default>
      <default class="hip">
        <joint axis="1 0 0" range="-0.76166 3.81442"/>
      </default>
      <default class="knee">
        <joint axis="1 0 0" range="-0.78540 1.65806"/>
      </default>
      
      <!-- Visual and collision definitions -->
      <default class="visual"> <geom type="mesh" contype="0" conaffinity="0" group="2"/> </default>
      <default class="collision"> <geom group="3"/>
        <default class="foot"> <geom type="sphere" size="0.009525" solimp="0.9 .95 0.01" condim="3" friction="0.8 0.1 0.1"/> </default>
      </default>
    </default>
  </default>

  <!-- Assets and Worldbody remain the same -->
  <asset>
    <mesh name="body" file="body.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Hip_L" file="Hip_L.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Hip_R" file="Hip_R.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Upper_Leg_L" file="Upper_Leg_L.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Upper_Leg_R" file="Upper_Leg_R.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Lower_Leg_L" file="Lower_Leg_L.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Lower_Leg_R" file="Lower_Leg_R.stl" scale="0.001 0.001 0.001"/>
  </asset>

  <worldbody>
    <light name="spotlight" mode="targetbodycom" target="torso" pos="3 0 4"/>
    <body name="torso" pos="0 0 0.2" childclass="pupper">
      <camera name="track" pos="0.8 -1.0 0.5" xyaxes="0.707 0.707 0 -0.354 0.354 0.866" mode="trackcom"/>
      <site name="head" pos="0.15 0 0" rgba="1 0 0 1" size="0.02" group="5"/>
      <inertial pos="0 -0.048 -0.00964" mass="0.991" fullinertia="0.00626 0.00175 0.00678 2e-05 0 2e-05" />
      <freejoint/>
      <geom class="visual" mesh="body"/>
      <geom class="collision" type="box" size="0.06 0.11 0.03" pos="0 -0.07 0"/>
      <site name="imu" pos="0 -0.122542 0" size="0.01" group="5"/>
      <body name="FR_hip" pos="-0.046891 -0.203946 -0.0064">
        <inertial pos="0.0139 -0.0269 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="FR_hip_joint"/>
        <geom class="visual" mesh="Hip_R"/>
        <body name="FR_thigh" pos="-0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="FR_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_R"/>
          <body name="FR_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="-0.00588 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="FR_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_R"/>
            <geom name="FR" class="foot" pos="0.003475 0 -0.11"/>
            <site name="FR" pos="0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
      <body name="FL_hip" pos="0.047109 -0.203946 -0.0064">
        <inertial pos="0.0139 0.0254 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="FL_hip_joint"/>
        <geom class="visual" mesh="Hip_L"/>
        <body name="FL_thigh" pos="0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="FL_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_L"/>
          <body name="FL_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="0.00558 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="FL_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_L"/>
            <geom name="FL" class="foot" pos="-0.003475 0 -0.11"/>
            <site name="FL" pos="-0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
      <body name="RR_hip" pos="-0.046896 -0.004096 -0.0064">
        <inertial pos="0.0139 -0.0269 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="RR_hip_joint"/>
        <geom class="visual" mesh="Hip_R"/>
        <body name="RR_thigh" pos="-0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="RR_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_R"/>
          <body name="RR_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="-0.00588 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="RR_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_R"/>
            <geom name="RR" class="foot" pos="0.003475 0 -0.11"/>
            <site name="RR" pos="0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
      <body name="RL_hip" pos="0.047104 -0.004096 -0.0064">
        <inertial pos="0.0139 0.0254 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="RL_hip_joint"/>
        <geom class="visual" mesh="Hip_L"/>
        <body name="RL_thigh" pos="0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="RL_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_L"/>
          <body name="RL_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="0.00558 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="RL_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_L"/>
            <geom name="RL" class="foot" pos="-0.003475 0 -0.11"/>
            <site name="RL" pos="-0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
    </body>
  </worldbody>

  <actuator>
      <general name="FR_hip"   joint="FR_hip_joint"/>
      <general name="FR_thigh" joint="FR_thigh_joint"/>
      <general name="FR_calf"  joint="FR_calf_joint"/>
      <general name="FL_hip"   joint="FL_hip_joint"/>
      <general name="FL_thigh" joint="FL_thigh_joint"/>
      <general name="FL_calf"  joint="FL_calf_joint"/>
      <general name="RR_hip"   joint="RR_hip_joint"/>
      <general name="RR_thigh" joint="RR_thigh_joint"/>
      <general name="RR_calf"  joint="RR_calf_joint"/>
      <general name="RL_hip"   joint="RL_hip_joint"/>
      <general name="RL_thigh" joint="RL_thigh_joint"/>
      <general name="RL_calf"  joint="RL_calf_joint"/>
  </actuator>

  <!-- Sensors remain the same -->
  <sensor>
    <gyro site="imu" name="gyro"/>
    <velocimeter site="imu" name="local_linvel"/>
    <accelerometer site="imu" name="accelerometer"/>
    <framepos objtype="site" objname="imu" name="position"/>
    <framezaxis objtype="site" objname="imu" name="upvector"/>
    <framexaxis objtype="site" objname="imu" name="forwardvector"/>
    <framelinvel objtype="site" objname="imu" name="global_linvel"/>
    <frameangvel objtype="site" objname="imu" name="global_angvel"/>
    <framequat objtype="site" objname="imu" name="orientation"/>
    <framelinvel objtype="site" objname="FR" name="FR_global_linvel"/>
    <framelinvel objtype="site" objname="FL" name="FL_global_linvel"/>
    <framelinvel objtype="site" objname="RR" name="RR_global_linvel"/>
    <framelinvel objtype="site" objname="RL" name="RL_global_linvel"/>
    <framepos objtype="site" objname="FR" name="FR_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="FL" name="FL_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="RR" name="RR_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="RL" name="RL_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="head" name="head_pos"/>
  </sensor>
</mujoco>

--------------------------------------------
---  END OF FILE: assets/pupper_mjx.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/pupper_mjx_1.xml ---
----------------------------------------------

<!-- =================================================================
     Pupper Model - Final Version with Global PD(Kp, Kv) Settings
     ================================================================= -->
<mujoco model="pupper_global_pd">
  <compiler angle="radian" meshdir="assets" autolimits="true"/>
  <option iterations="1" ls_iterations="5" timestep="0.004" integrator="Euler">
    <flag eulerdamp="disable"/>
  </option>
  <custom>
    <numeric data="30" name="max_contact_points"/>
    <numeric data="12" name="max_geom_pairs"/>
  </custom>

  <!-- [MODIFIED] All physical and control parameters are now globally defined here -->
  <default>
    <default class="pupper">
      <!-- 1. Global physical properties for ALL joints -->
      <joint armature="0.005" damping="0.1" frictionloss="0.2"/>
      
      <!-- 2. Global controller template for ALL position actuators -->
      <!--    kp and kv are placeholders to be modified by the Python script -->
      <general gainprm="0.333" ctrlrange="-5.0 5.0" gear="1" biastype="none"/>


      <!-- Joint-specific kinematics -->
      <default class="abduction">
        <joint axis="0 1 0" range="-1.0472 1.0472"/>
      </default>
      <default class="hip">
        <joint axis="1 0 0" range="-0.76166 3.81442"/>
      </default>
      <default class="knee">
        <joint axis="1 0 0" range="-0.78540 1.65806"/>
      </default>
      
      <!-- Visual and collision definitions -->
      <default class="visual"> <geom type="mesh" contype="0" conaffinity="0" group="2"/> </default>
      <default class="collision"> <geom group="3"/>
        <default class="foot"> <geom type="sphere" size="0.009525" solimp="0.9 .95 0.01" condim="3" friction="0.8 0.1 0.1"/> </default>
      </default>
    </default>
  </default>

  <!-- Assets and Worldbody remain the same -->
  <asset>
    <mesh name="body" file="body.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Hip_L" file="Hip_L.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Hip_R" file="Hip_R.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Upper_Leg_L" file="Upper_Leg_L.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Upper_Leg_R" file="Upper_Leg_R.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Lower_Leg_L" file="Lower_Leg_L.stl" scale="0.001 0.001 0.001"/>
    <mesh name="Lower_Leg_R" file="Lower_Leg_R.stl" scale="0.001 0.001 0.001"/>
  </asset>

  <worldbody>
    <light name="spotlight" mode="targetbodycom" target="torso" pos="3 0 4"/>
    <body name="torso" pos="0 0 0.2" childclass="pupper">
      <camera name="track" pos="0.8 -1.0 0.5" xyaxes="0.707 0.707 0 -0.354 0.354 0.866" mode="trackcom"/>
      <site name="head" pos="0.15 0 0" rgba="1 0 0 1" size="0.02" group="5"/>
      <inertial pos="0 -0.048 -0.00964" mass="0.991" fullinertia="0.00626 0.00175 0.00678 2e-05 0 2e-05" />
      <freejoint/>
      <geom class="visual" mesh="body"/>
      <geom class="collision" type="box" size="0.06 0.11 0.03" pos="0 -0.07 0"/>
      <site name="imu" pos="0 -0.122542 0" size="0.01" group="5"/>
      <body name="FR_hip" pos="-0.046891 -0.203946 -0.0064">
        <inertial pos="0.0139 -0.0269 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="FR_hip_joint"/>
        <geom class="visual" mesh="Hip_R"/>
        <body name="FR_thigh" pos="-0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="FR_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_R"/>
          <body name="FR_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="-0.00588 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="FR_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_R"/>
            <geom name="FR" class="foot" pos="0.003475 0 -0.11"/>
            <site name="FR" pos="0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
      <body name="FL_hip" pos="0.047109 -0.203946 -0.0064">
        <inertial pos="0.0139 0.0254 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="FL_hip_joint"/>
        <geom class="visual" mesh="Hip_L"/>
        <body name="FL_thigh" pos="0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="FL_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_L"/>
          <body name="FL_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="0.00558 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="FL_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_L"/>
            <geom name="FL" class="foot" pos="-0.003475 0 -0.11"/>
            <site name="FL" pos="-0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
      <body name="RR_hip" pos="-0.046896 -0.004096 -0.0064">
        <inertial pos="0.0139 -0.0269 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="RR_hip_joint"/>
        <geom class="visual" mesh="Hip_R"/>
        <body name="RR_thigh" pos="-0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="RR_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_R"/>
          <body name="RR_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="-0.00588 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="RR_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_R"/>
            <geom name="RR" class="foot" pos="0.003475 0 -0.11"/>
            <site name="RR" pos="0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
      <body name="RL_hip" pos="0.047104 -0.004096 -0.0064">
        <inertial pos="0.0139 0.0254 0" mass="0.106" diaginertia="2e-05 6e-05 6e-05" />
        <joint class="abduction" name="RL_hip_joint"/>
        <geom class="visual" mesh="Hip_L"/>
        <body name="RL_thigh" pos="0.037 0.028 0" axisangle="1 0 0 0.7854">
          <inertial pos="0.0172 0 -0.061" mass="0.142" diaginertia="0.00014 0.00016 3e-05" />
          <joint class="hip" name="RL_thigh_joint"/>
          <geom class="visual" mesh="Upper_Leg_L"/>
          <body name="RL_calf" pos="0 0 -0.08" axisangle="1 0 0 -1.57">
            <inertial pos="0.00558 -0.00075 -0.0658" mass="0.038" diaginertia="0.00018 0.00018 2e-05" />
            <joint class="knee" name="RL_calf_joint"/>
            <geom class="visual" mesh="Lower_Leg_L"/>
            <geom name="RL" class="foot" pos="-0.003475 0 -0.11"/>
            <site name="RL" pos="-0.003475 0 -0.11" type="sphere" size="0.009525" group="5"/>
          </body>
        </body>
      </body>
    </body>
  </worldbody>

  <actuator>
      <general name="FR_hip"   joint="FR_hip_joint"/>
      <general name="FR_thigh" joint="FR_thigh_joint"/>
      <general name="FR_calf"  joint="FR_calf_joint"/>
      <general name="FL_hip"   joint="FL_hip_joint"/>
      <general name="FL_thigh" joint="FL_thigh_joint"/>
      <general name="FL_calf"  joint="FL_calf_joint"/>
      <general name="RR_hip"   joint="RR_hip_joint"/>
      <general name="RR_thigh" joint="RR_thigh_joint"/>
      <general name="RR_calf"  joint="RR_calf_joint"/>
      <general name="RL_hip"   joint="RL_hip_joint"/>
      <general name="RL_thigh" joint="RL_thigh_joint"/>
      <general name="RL_calf"  joint="RL_calf_joint"/>
  </actuator>

  <!-- Sensors remain the same -->
  <sensor>
    <gyro site="imu" name="gyro"/>
    <velocimeter site="imu" name="local_linvel"/>
    <accelerometer site="imu" name="accelerometer"/>
    <framepos objtype="site" objname="imu" name="position"/>
    <framezaxis objtype="site" objname="imu" name="upvector"/>
    <framexaxis objtype="site" objname="imu" name="forwardvector"/>
    <framelinvel objtype="site" objname="imu" name="global_linvel"/>
    <frameangvel objtype="site" objname="imu" name="global_angvel"/>
    <framequat objtype="site" objname="imu" name="orientation"/>
    <framelinvel objtype="site" objname="FR" name="FR_global_linvel"/>
    <framelinvel objtype="site" objname="FL" name="FL_global_linvel"/>
    <framelinvel objtype="site" objname="RR" name="RR_global_linvel"/>
    <framelinvel objtype="site" objname="RL" name="RL_global_linvel"/>
    <framepos objtype="site" objname="FR" name="FR_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="FL" name="FL_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="RR" name="RR_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="RL" name="RL_pos" reftype="site" refname="imu"/>
    <framepos objtype="site" objname="head" name="head_pos"/>
  </sensor>
</mujoco>

----------------------------------------------
---  END OF FILE: assets/pupper_mjx_1.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene.xml ---
---------------------------------------

<mujoco model="pupper scene">
  <!-- åŒ…å«æ©Ÿå™¨äººæ¨¡å‹ -->
  <include file="pupper.xml"/>

  <statistic center="0 0 0.1" extent="0.8"/>

  <visual>
    <headlight diffuse="0.6 0.6 0.6" ambient="0.3 0.3 0.3" specular="0 0 0"/>
    <rgba haze="0.15 0.25 0.35 1"/>
    <global azimuth="120" elevation="-20"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="0.3 0.5 0.7" rgb2="0 0 0" width="512" height="3072"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="0.2 0.3 0.4" rgb2="0.1 0.2 0.3"
      markrgb="0.8 0.8 0.8" width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0.2"/>
  </asset>

  <worldbody>
    <light pos="0 0 1.5" dir="0 0 -1" directional="true"/>
    <camera name="default" pos="0.846 -1.465 0.916" xyaxes="0.866 0.500 0.000 -0.171 0.296 0.940"/>
    <geom name="floor" size="0 0 0.05" type="plane" material="groundplane"/>
    
  <keyframe>
    <!-- ç‚ºPupperå®šç¾©ä¸€å€‹'home'ç«™ç«‹å§¿æ…‹ -->
    <!-- qpos: [root_pos(3), root_quat(4), FR(3), FL(3), RR(3), RL(3)] -->
    <!-- åŸå§‹Pupperæ¨¡å‹çš„home: [0 0.4 -0.8] for each leg (abduction, hip, knee) -->
    <key name="home" qpos="
    0 0 0.2
    1 0 0 0
    0 0.0 0.0
    0 0.0 0.0
    0 0.0 0.0
    0 0.0 0.0"
      ctrl="0 0 0  0 0 0  0 0 0  0 0 0"/>
  </keyframe>


    <!-- =========================================================== -->
    <!-- === æ–°å¢éƒ¨åˆ† 1ï¼šMocap Body (æˆ‘å€‘çš„ç©ºä¸­éŒ¨é») === -->
    <!-- mocap="true" è¡¨ç¤ºå®ƒçš„ä½ç½®ç”±æˆ‘å€‘æ‰‹å‹•è¨­å®š -->
    <!-- å°‡å…¶æ”¾åœ¨ worldbody çš„é ‚å±¤ -->
    <body name="anchor" pos="0 0 0.35" mocap="true">
      <!-- æˆ‘å€‘å¯ä»¥çµ¦å®ƒä¸€å€‹çœ‹ä¸è¦‹çš„ geom ä¾†è¦–è¦ºåŒ–å®ƒçš„ä½ç½®ï¼Œæ–¹ä¾¿é™¤éŒ¯ -->
      <geom type="sphere" size="0.02" rgba="1 0 0 0.5" contype="0" conaffinity="0"/>
    </body>
    <!-- =========================================================== -->

  </worldbody>

  <!-- ============================================================= -->
  <!-- === æ–°å¢éƒ¨åˆ† 2ï¼šWeld ç´„æŸ === -->
  <!-- å°‡å…¶æ”¾åœ¨ mujoco æ¨™ç±¤çš„é ‚å±¤ -->
  <!-- é€™å€‹ç´„æŸå°‡ pupper.xml ä¸­çš„ "torso" "ç„Šæ¥" åˆ°æˆ‘å€‘ä¸Šé¢å®šç¾©çš„ "anchor" ä¸Š -->
  <!-- active="false" è¡¨ç¤ºé è¨­æ˜¯ç¦ç”¨çš„ -->
  <equality>
    <weld name="torso_anchor_weld" body1="torso" body2="anchor" solimp="0.9 0.95 0.001" solref="0.02 1" active="false"/>
  </equality>
  <!-- ============================================================= -->

</mujoco>

---------------------------------------
---  END OF FILE: assets/scene.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_hfield_mjx.xml ---
--------------------------------------------------

<mujoco model="barkour vB scene">
  <include file="pupper_mjx.xml"/>

  <statistic center="0 0 0.1" extent="0.8"/>

  <visual>
    <headlight diffuse="0.6 0.6 0.6" ambient="0.3 0.3 0.3" specular="0 0 0"/>
    <rgba haze="0.15 0.25 0.35 1"/>
    <global azimuth="120" elevation="-20"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="0.3 0.5 0.7" rgb2="0 0 0" width="512" height="3072"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="0.2 0.3 0.4" rgb2="0.1 0.2 0.3"
      markrgb="0.8 0.8 0.8" width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0.2"/>
    <hfield name="hfield" file="mesh-2/hfield.png" size="10 10 .02 0.1"/>
  </asset>

  <worldbody>
    <light pos="0 0 1.5" dir="0 0 -1" directional="true"/>
    <camera name="default" pos="0.846 -1.465 0.916" xyaxes="0.866 0.500 0.000 -0.171 0.296 0.940"/>
    <geom name="floor" type="hfield" hfield="hfield" conaffinity="1" material="groundplane"/>
  </worldbody>
</mujoco>

--------------------------------------------------
---  END OF FILE: assets/scene_hfield_mjx.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx.xml ---
-------------------------------------------

<!-- assets/scene_mjx.xml -->
<mujoco model="Pupper Scene MJX">
  <include file="assets/pupper_mjx.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <headlight diffuse=".8 .8 .8" ambient=".2 .2 .2" specular="1 1 1"/>
    <global azimuth="120" elevation="-20"/>
    <quality shadowsize="4096"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1=".6 .7 .8" rgb2=".2 .3 .4" width="800" height="800"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1=".2 .3 .4" rgb2=".1 .2 .3" markrgb=".8 .8 .8"
      width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0"/>
    
    <!-- ã€æ–°å¢ã€‘å®šç¾©é«˜åº¦å ´è³‡ç”¢ -->
    <!-- nrow å’Œ ncol å®šç¾©äº†è§£æåº¦ (ä¾‹å¦‚ 100x100 çš„ç¶²æ ¼) -->
    <!-- size å®šç¾©äº†ç‰©ç†å°ºå¯¸ (ä¾‹å¦‚ 10ç±³ x 10ç±³ x æœ€å¤§é«˜åº¦1ç±³) -->
    <hfield name="terrain" nrow="100" ncol="100" size="5 5 1 0.1"/>
  </asset>

  <worldbody>
    <!-- ã€ä¿®æ”¹ã€‘å°‡åŸä¾†çš„å¹³é¢åœ°æ¿ geom æ›¿æ›ç‚ºé«˜åº¦å ´ geom -->
    <!-- <geom name="floor" size="0 0 0.05" type="plane" material="groundplane" condim="3" contype="1" conaffinity="0"/> -->
    <geom name="floor" type="hfield" hfield="terrain" material="groundplane" condim="3" contype="1" conaffinity="0"/>
    
    <body name="anchor" pos="0 0 0.35" mocap="true">
      <geom type="sphere" size="0.02" rgba="1 0 0 0.5" contype="0" conaffinity="0"/>
    </body>
  </worldbody>

  <equality>
    <weld name="torso_anchor_weld" body1="torso" body2="anchor" solimp="0.9 0.95 0.001" solref="0.02 1" active="false"/>
  </equality>
  
  <keyframe>
    <key name="home" qpos="
    0 0 0.3
    1 0 0 0 
    0.0  0.0  0.0  
    0.0  0.0  0.0  
    0.0  0.0  0.0  
    0.0  0.0  0.0 "/>
  </keyframe>
</mujoco>

-------------------------------------------
---  END OF FILE: assets/scene_mjx.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx_feetonly_bowl.xml ---
---------------------------------------------------------

<mujoco model="go1 feet only scene">
  <include file="go1_mjx_feetonly.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <rgba force="1 0 0 1"/>
    <global azimuth="120" elevation="-20"/>
    <map force="0.01"/>
    <scale forcewidth="0.3" contactwidth="0.5" contactheight="0.2"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1" width="800" height="800"/>
    <texture type="2d" name="groundplane" file="assets/rocky_texture.png"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance=".8"/>
    <hfield name="terrain" ncol="201" nrow="201" size="30 30 5 .1"/>
  </asset>

  <worldbody>
    <camera name="global"  pos="-5 5 5" xyaxes="-1 -1 0 1 0 1" mode="trackcom"/>
    <geom name="floor" type="hfield" hfield="terrain" material="groundplane" pos="0 0 -.01"/>
  </worldbody>

  <keyframe>
    <key name="home" qpos="0 0 0.35 1 0 0 0 0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8"
      ctrl="0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8"/>
    <key name="home_higher"
    qpos="0 0 0.35 1 0 0 0 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"
    ctrl="0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"/>
  </keyframe>
</mujoco>


---------------------------------------------------------
---  END OF FILE: assets/scene_mjx_feetonly_bowl.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx_feetonly_flat_terrain.xml ---
-----------------------------------------------------------------

<mujoco model="go1 feetonly flat terrain scene">
  <include file="go1_mjx_feetonly.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <headlight diffuse=".8 .8 .8" ambient=".2 .2 .2" specular="1 1 1"/>
    <rgba force="1 0 0 1"/>
    <global azimuth="120" elevation="-20"/>
    <map force="0.01"/>
    <scale forcewidth="0.3" contactwidth="0.5" contactheight="0.2"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1" width="800" height="800"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="1 1 1" rgb2="1 1 1" markrgb="0 0 0"
      width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0"/>
  </asset>

  <worldbody>
    <geom name="floor" size="0 0 0.01" type="plane" material="groundplane" contype="1" conaffinity="0" priority="1"
      friction="0.6" condim="3"/>
  </worldbody>

  <keyframe>
    <key name="home" qpos="
    0 0 0.278
    1 0 0 0
    0.1 0.9 -1.8
    -0.1 0.9 -1.8
    0.1 0.9 -1.8
    -0.1 0.9 -1.8"
      ctrl="0.1 0.9 -1.8 -0.1 0.9 -1.8 0.1 0.9 -1.8 -0.1 0.9 -1.8"/>
    <key name="home_higher" qpos="0 0 0.31 1 0 0 0 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"
      ctrl="0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"/>
    <key
    name="footstand"
    qpos='
    0 0 0.54
    0.8 0 -0.8 0
    0 0.82 -1.6 0 0.82 -1.68 0 1.82 -1.16 0.0 1.82 -1.16'
    ctrl='0 0.82 -1.6 0 0.82 -1.68 0 1.82 -1.16 0.0 1.82 -1.16'/>
    <key name="handstand"
      qpos="0 0 0.54
      0.8 0 0.8 0
      0 -0.686 -1.16
      0 -0.686 -1.16
      0 1.7 -1.853
      0 1.7 -1.853"
      ctrl="0 -0.686 -1.16 0 -0.686 -1.16 0 1.7 -1.853 0 1.7 -1.853"/>
    <key name="pre_recovery"
      qpos="-0.0318481 -0.000215369 0.0579031 1 -2.70738e-05 6.06169e-05 0.000231261 -0.352275 1.18554 -2.80738 0.360892 1.1806 -2.80281 -0.381197 1.16812 -2.79123 0.391054 1.1622 -2.78576"
      ctrl="-0.352275 1.18554 -2.80738 0.360892 1.1806 -2.80281 -0.381197 1.16812 -2.79123 0.391054 1.1622 -2.78576"/>
  </keyframe>
</mujoco>


-----------------------------------------------------------------
---  END OF FILE: assets/scene_mjx_feetonly_flat_terrain.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx_feetonly_rough_terrain.xml ---
------------------------------------------------------------------

<mujoco model="go1 feet only rough terrain scene">
  <include file="go1_mjx_feetonly.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <rgba force="1 0 0 1"/>
    <global azimuth="120" elevation="-20"/>
    <map force="0.01"/>
    <scale forcewidth="0.3" contactwidth="0.5" contactheight="0.2"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <!-- https://polyhaven.com/a/rock_face -->
    <texture type="2d" name="groundplane" file="assets/rocky_texture.png"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance=".8"/>
    <hfield name="hfield" file="assets/hfield.png" size="10 10 .05 0.1"/>
  </asset>

  <worldbody>
    <geom name="floor" type="hfield" hfield="hfield" material="groundplane" contype="1" conaffinity="0" priority="1"
      friction="1.0"/>
  </worldbody>

  <keyframe>
    <key name="home" qpos="
    0 0 0.35
    1 0 0 0
    0.1 0.9 -1.8
    -0.1 0.9 -1.8
    0.1 0.9 -1.8
    -0.1 0.9 -1.8"
      ctrl="0.1 0.9 -1.8 -0.1 0.9 -1.8 0.1 0.9 -1.8 -0.1 0.9 -1.8"/>
    <key name="home_higher" qpos="0 0 0.35 1 0 0 0 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"
      ctrl="0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"/>
  </keyframe>
</mujoco>


------------------------------------------------------------------
---  END OF FILE: assets/scene_mjx_feetonly_rough_terrain.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx_feetonly_stairs.xml ---
-----------------------------------------------------------

<mujoco model="go1 scene">
  <include file="go1_mjx_feetonly.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <headlight diffuse=".8 .8 .8" ambient=".2 .2 .2" specular="1 1 1"/>
    <rgba force="1 0 0 1"/>
    <global azimuth="120" elevation="-20"/>
    <map force="0.01"/>
    <scale forcewidth="0.3" contactwidth="0.5" contactheight="0.2"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1" width="800" height="800"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="1 1 1" rgb2="1 1 1" markrgb="0 0 0"
      width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0"/>
    <material name="stairs" rgba="1 1 1 1" reflectance=".8"/>
  </asset>

  <default>
    <default class="stairs">
      <geom material="stairs" contype="1" conaffinity="0"/>
    </default>
  </default>

  <worldbody>
    <geom name="floor" size="0 0 0.01" material="groundplane" type="plane" contype="1" conaffinity="0"/>

    <body name="stairs" pos="0.2 0 0" childclass="stairs">
      <geom pos="0.2 0 0.075" type="box" size="0.1 0.75 0.025"/>
      <geom pos="0.4 0 0.22" type="box" size="0.1 0.75 0.025"/>
      <geom pos="0.6 0 0.375" type="box" size="0.1 0.75 0.025"/>
      <geom pos="0.8 0 0.525" type="box" size="0.1 0.75 0.025"/>
      <geom pos="1.0 0 0.675" type="box" size="0.1 0.75 0.025"/>
      <geom pos="1.2 0 0.825" type="box" size="0.1 0.75 0.025"/>
      <geom pos="1.4 0 0.975" type="box" size="0.1 0.75 0.025"/>
      <geom pos="1.6 0 1.125" type="box" size="0.1 0.75 0.025"/>
      <geom pos="1.8 0 1.275" type="box" size="0.1 0.75 0.025"/>
      <geom pos="2 0 1.42" type="box" size="0.1 0.75 0.025"/>
      <geom pos="2.2 0 1.57" type="box" size="0.1 0.75 0.025"/>
      <geom pos="2.4 0 1.72" type="box" size="0.1 0.75 0.025"/>
      <geom pos="2.6 0 1.87" type="box" size="0.1 0.75 0.025"/>
      <geom pos="2.8 0 2.02" type="box" size="0.1 0.75 0.025"/>
      <geom pos="3 0 2.17" type="box" size="0.1 0.75 0.025"/>
      <geom pos="3.2 0 2.32" type="box" size="0.1 0.75 0.025"/>
      <geom pos="3.4 0 2.47" type="box" size="0.1 0.75 0.025"/>
      <geom pos="3.6 0 2.62" type="box" size="0.1 0.75 0.025"/>
      <geom pos="3.8 0 2.77" type="box" size="0.1 0.75 0.025"/>
      <geom pos="4 0 2.92" type="box" size="0.1 0.75 0.025"/>
    </body>
  </worldbody>

  <keyframe>
    <key name="home" qpos="0 0 0.27 1 0 0 0 0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8"
      ctrl="0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8 0 0.9 -1.8"/>
  </keyframe>
</mujoco>


-----------------------------------------------------------
---  END OF FILE: assets/scene_mjx_feetonly_stairs.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx_flat_terrain.xml ---
--------------------------------------------------------

<mujoco model="go1 scene">
  <include file="go1_mjx.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <headlight diffuse=".8 .8 .8" ambient=".2 .2 .2" specular="1 1 1"/>
    <rgba force="1 0 0 1"/>
    <global azimuth="120" elevation="-20"/>
    <map force="0.01"/>
    <scale forcewidth="0.3" contactwidth="0.5" contactheight="0.2"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1" width="800" height="800"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="1 1 1" rgb2="1 1 1" markrgb="0 0 0"
      width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0"/>
  </asset>

  <worldbody>
    <geom name="floor" size="0 0 0.01" type="plane" material="groundplane" priority="1" friction="0.6" condim="3" contype="1" conaffinity="0"/>
  </worldbody>

  <keyframe>
    <key name="home" qpos="
    0 0 0.278
    1 0 0 0
    0.1 0.9 -1.8
    -0.1 0.9 -1.8
    0.1 0.9 -1.8
    -0.1 0.9 -1.8"
      ctrl="0.1 0.9 -1.8 -0.1 0.9 -1.8 0.1 0.9 -1.8 -0.1 0.9 -1.8"/>
    <key name="home_higher" qpos="0 0 0.31 1 0 0 0 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"
      ctrl="0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"/>
    <key name="pre_recovery"
      qpos="-0.0318481 -0.000215369 0.0579031 1 -2.70738e-05 6.06169e-05 0.000231261 -0.352275 1.18554 -2.80738 0.360892 1.1806 -2.80281 -0.381197 1.16812 -2.79123 0.391054 1.1622 -2.78576"
      ctrl="-0.352275 1.18554 -2.80738 0.360892 1.1806 -2.80281 -0.381197 1.16812 -2.79123 0.391054 1.1622 -2.78576"/>
    <key name="footstand"
      qpos="0 0 0.54 0.8 0 -0.8 0 0 0.82 -1.6 0 0.82 -1.68 0 1.82 -1.16 0.0 1.82 -1.16"
      ctrl="0 0.82 -1.6 0 0.82 -1.68 0 1.82 -1.16 0.0 1.82 -1.16"/>
    <key name="handstand"
      qpos="0 0 0.54 0.8 0 0.8 0 0 -0.686 -1.16 0 -0.686 -1.16 0 1.7 -1.853 0 1.7 -1.853"
      ctrl="0 -0.686 -1.16 0 -0.686 -1.16 0 1.7 -1.853 0 1.7 -1.853"/>
  </keyframe>
</mujoco>


--------------------------------------------------------
---  END OF FILE: assets/scene_mjx_flat_terrain.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/scene_mjx_fullcollisions_flat_terrain.xml ---
-----------------------------------------------------------------------

<mujoco model="go1 scene">
  <include file="go1_mjx_fullcollisions.xml"/>

  <statistic center="0 0 0.1" extent="0.8" meansize="0.04"/>

  <visual>
    <headlight diffuse=".8 .8 .8" ambient=".2 .2 .2" specular="1 1 1"/>
    <rgba force="1 0 0 1"/>
    <global azimuth="120" elevation="-20"/>
    <map force="0.01"/>
    <scale forcewidth="0.3" contactwidth="0.5" contactheight="0.2"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="1 1 1" rgb2="1 1 1" width="800" height="800"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="1 1 1" rgb2="1 1 1" markrgb="0 0 0"
      width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0"/>
  </asset>

  <worldbody>
    <geom name="floor" size="0 0 0.01" type="plane" material="groundplane" priority="1" friction="0.6" condim="3" contype="1" conaffinity="0"/>
  </worldbody>

  <keyframe>
    <key name="home" qpos="
    0 0 0.278
    1 0 0 0
    0.1 0.9 -1.8
    -0.1 0.9 -1.8
    0.1 0.9 -1.8
    -0.1 0.9 -1.8"
      ctrl="0.1 0.9 -1.8 -0.1 0.9 -1.8 0.1 0.9 -1.8 -0.1 0.9 -1.8"/>
    <key name="home_higher" qpos="0 0 0.31 1 0 0 0 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"
      ctrl="0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63 0 0.82 -1.63"/>
    <key name="pre_recovery"
      qpos="-0.0318481 -0.000215369 0.0579031 1 -2.70738e-05 6.06169e-05 0.000231261 -0.352275 1.18554 -2.80738 0.360892 1.1806 -2.80281 -0.381197 1.16812 -2.79123 0.391054 1.1622 -2.78576"
      ctrl="-0.352275 1.18554 -2.80738 0.360892 1.1806 -2.80281 -0.381197 1.16812 -2.79123 0.391054 1.1622 -2.78576"/>
    <key name="footstand"
      qpos="0 0 0.54 0.8 0 -0.8 0 0 0.82 -1.6 0 0.82 -1.68 0 1.82 -1.16 0.0 1.82 -1.16"
      ctrl="0 0.82 -1.6 0 0.82 -1.68 0 1.82 -1.16 0.0 1.82 -1.16"/>
    <key name="handstand"
      qpos="0 0 0.54 0.8 0 0.8 0 0 -0.686 -1.16 0 -0.686 -1.16 0 1.7 -1.853 0 1.7 -1.853"
      ctrl="0 -0.686 -1.16 0 -0.686 -1.16 0 1.7 -1.853 0 1.7 -1.853"/>
  </keyframe>
</mujoco>


-----------------------------------------------------------------------
---  END OF FILE: assets/scene_mjx_fullcollisions_flat_terrain.xml  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/Hip_L.stl ---
--------------------------------------------

[Content skipped for file type '.stl': Hip_L.stl (4.96 KB)]

--------------------------------------------
---  END OF FILE: assets/mesh/Hip_L.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/Hip_R.stl ---
--------------------------------------------

[Content skipped for file type '.stl': Hip_R.stl (4.96 KB)]

--------------------------------------------
---  END OF FILE: assets/mesh/Hip_R.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/Lower_Leg_L.stl ---
--------------------------------------------------

[Content skipped for file type '.stl': Lower_Leg_L.stl (31.72 KB)]

--------------------------------------------------
---  END OF FILE: assets/mesh/Lower_Leg_L.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/Lower_Leg_R.stl ---
--------------------------------------------------

[Content skipped for file type '.stl': Lower_Leg_R.stl (31.72 KB)]

--------------------------------------------------
---  END OF FILE: assets/mesh/Lower_Leg_R.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/Upper_Leg_L.stl ---
--------------------------------------------------

[Content skipped for file type '.stl': Upper_Leg_L.stl (2.33 KB)]

--------------------------------------------------
---  END OF FILE: assets/mesh/Upper_Leg_L.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/Upper_Leg_R.stl ---
--------------------------------------------------

[Content skipped for file type '.stl': Upper_Leg_R.stl (2.33 KB)]

--------------------------------------------------
---  END OF FILE: assets/mesh/Upper_Leg_R.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/body.stl ---
-------------------------------------------

[Content skipped for file type '.stl': body.stl (3.01 KB)]

-------------------------------------------
---  END OF FILE: assets/mesh/body.stl  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/hfield.png ---
---------------------------------------------

[Content skipped for file type '.png': hfield.png (165.70 KB)]

---------------------------------------------
---  END OF FILE: assets/mesh/hfield.png  ---
================================================================================

================================================================================
--- START OF FILE: assets/mesh/rocky_texture.png ---
----------------------------------------------------

[Content skipped for file type '.png': rocky_texture.png (1571.20 KB)]

----------------------------------------------------
---  END OF FILE: assets/mesh/rocky_texture.png  ---
================================================================================

================================================================================
--- START OF FILE: models/pupper_ppo_policy_200540160_tf_converted.onnx ---
---------------------------------------------------------------------------

[Content skipped for file type '.onnx': pupper_ppo_policy_200540160_tf_converted.onnx (756.39 KB)]

---------------------------------------------------------------------------
---  END OF FILE: models/pupper_ppo_policy_200540160_tf_converted.onnx  ---
================================================================================

================================================================================
--- START OF FILE: models/pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.onnx ---
--------------------------------------------------------------------------------

[Content skipped for file type '.onnx': pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.onnx (756.39 KB)]

--------------------------------------------------------------------------------
---  END OF FILE: models/pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.onnx  ---
================================================================================

================================================================================
--- START OF FILE: models/pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.optimized.ort ---
-----------------------------------------------------------------------------------------

[Content skipped for file type '.ort': pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.optimized.ort (762.41 KB)]

-----------------------------------------------------------------------------------------
---  END OF FILE: models/pupper_ppo_policy_30965760_tf_converted_ç©©å®šæ­¥æ…‹ç‰ˆ.optimized.ort  ---
================================================================================

================================================================================
--- START OF FILE: test/dump_project.py ---
-------------------------------------------

# test/dump_project.py (æœ€çµ‚é˜²éè¿´ç‰ˆ)
import os
import sys
from datetime import datetime

# --- çµ„æ…‹è¨­å®š ---

# 1. è¦å¿½ç•¥çš„è³‡æ–™å¤¾åç¨±
EXCLUDE_DIRS = {
    '.git', 'node_modules', '__pycache__', 'venv', '.vscode',
    'dist', 'build', 'env', '.idea', 'target', '.DS_Store'
}

# 2. å®šç¾©ä¸€å€‹ã€Œå…§å®¹è·³éæ¸…å–®ã€ã€‚
SKIP_CONTENT_EXTENSIONS = {
    '.onnx', '.stl', '.ort', '.png', '.jpg', '.jpeg',
    '.exe', '.dll', '.so', '.o', '.zip', '.rar', '.gz',
    '.gif', '.bmp', '.ico', '.mp3', '.mp4', '.avi',
    '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx',
    '.pyc', '.pyo', '.lock', '.swp', '.swo',
}

# 3. (å¯é¸) å¦‚æœåªæƒ³åŒ…å«ç‰¹å®šé¡å‹çš„æª”æ¡ˆï¼Œå¯ä»¥è¨­å®šé€™å€‹æ¸…å–®
INCLUDE_EXTENSIONS = set()


# --- æ¨¹ç‹€çµæ§‹ç”¢ç”Ÿå‡½å¼ (ç„¡é ˆä¿®æ”¹) ---
def generate_tree_structure(root_dir, project_name):
    tree_lines = []
    
    def _generate_tree_recursive(current_dir, prefix=""):
        items = []
        try:
            items = os.listdir(current_dir)
        except OSError as e:
            print(f"è­¦å‘Šï¼šç„¡æ³•å­˜å–ç›®éŒ„ {current_dir} ({e})")
            return

        dirs = sorted([d for d in items if os.path.isdir(os.path.join(current_dir, d)) and d not in EXCLUDE_DIRS])
        
        # ã€ä¿®æ”¹ã€‘éæ¿¾æ‰æˆ‘å€‘è‡ªå·±ç”¢ç”Ÿçš„è¼¸å‡ºæª”æ¡ˆ
        files_to_process = []
        for f in sorted([f for f in items if os.path.isfile(os.path.join(current_dir, f))]):
            is_old_dump = f.startswith(f"{project_name}_dump_") and f.endswith(".txt")
            is_legacy_dump = f == "project_dump.txt"
            if not is_old_dump and not is_legacy_dump:
                files_to_process.append(f)
        
        all_items = dirs + files_to_process
        
        for i, item_name in enumerate(all_items):
            path = os.path.join(current_dir, item_name)
            is_last = (i == len(all_items) - 1)
            connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
            
            if os.path.isdir(path):
                tree_lines.append(f"{prefix}{connector}{item_name}/")
                new_prefix = prefix + ("    " if is_last else "â”‚   ")
                _generate_tree_recursive(path, new_prefix)
            else:
                if INCLUDE_EXTENSIONS and os.path.splitext(item_name)[1].lower() not in INCLUDE_EXTENSIONS:
                    continue
                tree_lines.append(f"{prefix}{connector}{item_name}")

    tree_lines.append(f"{project_name}/")
    _generate_tree_recursive(root_dir)
    return "\n".join(tree_lines)


# --- ç¨‹å¼ç¢¼å½™æ•´ä¸»å‡½å¼ ---
def generate_code_dump(root_dir, output_filename, project_name):
    if not os.path.isdir(root_dir):
        print(f"éŒ¯èª¤ï¼šç›®éŒ„ '{root_dir}' ä¸å­˜åœ¨ã€‚")
        return

    processed_files_count = 0
    
    try:
        with open(output_filename, 'w', encoding='utf-8', errors='ignore') as outfile:
            outfile.write(f"# å°ˆæ¡ˆç¨‹å¼ç¢¼å½™æ•´: {os.path.abspath(root_dir)}\n")
            outfile.write("=" * 80 + "\n\n")

            outfile.write("#" + "-" * 78 + "#\n")
            outfile.write("#" + " " * 30 + "å°ˆæ¡ˆç›®éŒ„çµæ§‹" + " " * 30 + "#\n")
            outfile.write("#" + "-" * 78 + "#\n\n")
            # ã€ä¿®æ”¹ã€‘å°‡ project_name å‚³å…¥
            tree_structure = generate_tree_structure(root_dir, project_name)
            outfile.write(tree_structure)
            outfile.write("\n\n\n")

            outfile.write("#" + "-" * 78 + "#\n")
            outfile.write("#" + " " * 31 + "å„æª”æ¡ˆå…§å®¹" + " " * 32 + "#\n")
            outfile.write("#" + "-" * 78 + "#\n\n")
            
            for dirpath, dirnames, filenames in os.walk(root_dir, topdown=True):
                dirnames[:] = [d for d in dirnames if d not in EXCLUDE_DIRS]

                for filename in sorted(filenames):
                    # =============================================================
                    # ===        ã€æ ¸å¿ƒä¿®æ­£ï¼šè·³éèˆŠçš„è¼¸å‡ºæª”ã€‘                     ===
                    # =============================================================
                    is_dynamic_dump = filename.startswith(f"{project_name}_dump_") and filename.endswith(".txt")
                    is_legacy_dump = filename == "project_dump.txt"

                    if is_dynamic_dump or is_legacy_dump:
                        print(f"æ­£åœ¨è·³é (èˆŠçš„è¼¸å‡ºæª”): {filename}")
                        continue
                    # =============================================================

                    file_path = os.path.join(dirpath, filename)
                    relative_path = os.path.relpath(file_path, root_dir).replace(os.sep, '/')

                    try:
                        print(f"æ­£åœ¨è™•ç†: {relative_path}")

                        start_header = f"--- START OF FILE: {relative_path} ---"
                        end_header   = f"---  END OF FILE: {relative_path}  ---"
                        separator    = "=" * 80
                        
                        outfile.write(f"{separator}\n")
                        outfile.write(f"{start_header}\n")
                        outfile.write(f"{'-' * len(start_header)}\n\n")
                        
                        _, extension = os.path.splitext(file_path)
                        
                        if extension.lower() in SKIP_CONTENT_EXTENSIONS:
                            file_size = os.path.getsize(file_path)
                            outfile.write(f"[Content skipped for file type '{extension}': {filename} ({file_size / 1024:.2f} KB)]")
                        else:
                            try:
                                with open(file_path, 'r', encoding='utf-8', errors='strict') as infile:
                                    outfile.write(infile.read())
                            except (UnicodeDecodeError, IOError):
                                file_size = os.path.getsize(file_path)
                                outfile.write(f"[Content skipped due to read error: {filename} ({file_size / 1024:.2f} KB)]")
                        
                        outfile.write(f"\n\n{'-' * len(end_header)}\n")
                        outfile.write(f"{end_header}\n")
                        outfile.write(f"{separator}\n\n")
                        
                        processed_files_count += 1
                    except Exception as e:
                        print(f"è­¦å‘Šï¼šç„¡æ³•è®€å– {relative_path} ({e})")

        print("\n" + "=" * 80)
        print(f"âœ… æˆåŠŸï¼å…±è™•ç†äº† {processed_files_count} å€‹æª”æ¡ˆã€‚")
        print(f"è¼¸å‡ºçµæœå·²å„²å­˜è‡³: {os.path.abspath(output_filename)}")
        print("=" * 80)

    except IOError as e:
        print(f"éŒ¯èª¤ï¼šç„¡æ³•å¯«å…¥è¼¸å‡ºæª”æ¡ˆ '{output_filename}'ã€‚ ({e})")
    except Exception as e:
        print(f"ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: {e}")


if __name__ == "__main__":
    script_path = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(script_path)
    
    os.chdir(project_root)
    
    target_dir = '.'
    
    project_name = os.path.basename(os.path.abspath(project_root))
    timestamp_str = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    output_file = f"{project_name}_dump_{timestamp_str}.txt"
    
    print(f"è¨­å®šå°ˆæ¡ˆæ ¹ç›®éŒ„ç‚º: {os.path.abspath(project_root)}")
    print(f"å°‡å¾ '{os.path.abspath(target_dir)}' é–‹å§‹æƒæ...")
    print(f"è¼¸å‡ºæª”æ¡ˆå°‡å‘½åç‚º: {output_file}")
    
    generate_code_dump(target_dir, output_file, project_name)

-------------------------------------------
---  END OF FILE: test/dump_project.py  ---
================================================================================

================================================================================
--- START OF FILE: test/test_joystick.py ---
--------------------------------------------

# test_joystick.py
import pygame
import time

pygame.init()
pygame.joystick.init()

if pygame.joystick.get_count() == 0:
    print("éŒ¯èª¤ï¼šæœªåµæ¸¬åˆ°ä»»ä½•æ–æ¡¿ã€‚")
    exit()

joystick = pygame.joystick.Joystick(0)
joystick.init()

print(f"å·²é€£æ¥åˆ°: {joystick.get_name()}")
print(f"æ–æ¡¿æœ‰ {joystick.get_numaxes()} å€‹è»¸ã€‚")
print("\nè«‹ç§»å‹•æ‚¨çš„æ–æ¡¿ï¼Œè§€å¯Ÿæ¯å€‹è»¸çš„ç·¨è™Ÿå’Œæ•¸å€¼è®ŠåŒ–...")
print("æŒ‰ Ctrl+C çµæŸæ¸¬è©¦ã€‚")

try:
    while True:
        for event in pygame.event.get():
            if event.type == pygame.JOYAXISMOTION:
                print(f"è»¸ (Axis) {event.axis}: {event.value:.3f}")
        time.sleep(0.01)
except KeyboardInterrupt:
    print("\næ¸¬è©¦çµæŸã€‚")

pygame.quit()

--------------------------------------------
---  END OF FILE: test/test_joystick.py  ---
================================================================================

================================================================================
--- START OF FILE: test/verify_model_mode.py ---
------------------------------------------------

# verify_model_mode.py
import numpy as np
import mujoco
import sys
import time
from pathlib import Path

# --- å°å…¥æ‚¨å°ˆæ¡ˆçš„æ¨¡çµ„ ---
from config import load_config
from policy import ONNXPolicy
from observation import ObservationBuilder # æˆ‘å€‘å°‡ä½¿ç”¨æ‚¨ä¿®æ”¹å¾Œçš„ç‰ˆæœ¬

# --- è…³æœ¬è¨­å®š ---
SIMULATION_DURATION = 3.0
PERTURBATION_VALUE = 0.3
STABILITY_THRESHOLD = 0.05
HIP_JOINT_INDICES = [1, 4, 7, 10]

def run_simulation(model, data, policy, obs_builder, duration):
    """
    é‹è¡Œä¸€å€‹æ¨¡æ“¬ç‰‡æ®µä¸¦æ”¶é›†æœ€å¾Œçš„ Raw Action æ•¸æ“šã€‚
    é€™å€‹ç‰ˆæœ¬å‡è¨­æ˜¯ã€Œçµ•å°è§’åº¦æ¨¡å¼ã€ã€‚
    """
    # åœ¨é€™å€‹æ¸¬è©¦è…³æœ¬ä¸­ï¼Œæˆ‘å€‘ç›´æ¥ä½¿ç”¨ä¸€å€‹å›ºå®šçš„PDå¢ç›Š
    model.actuator_gainprm[:, 0] = 5.0
    model.dof_damping[6:] = 0.5
    
    start_time = data.time
    recent_actions = []

    # ç°¡å–®çš„ç†±èº«
    warmup_duration = 1.0
    while data.time - start_time < warmup_duration:
        base_obs = obs_builder.get_observation(np.zeros(3), policy.last_action)
        _, action_raw = policy.get_action(base_obs)
        # ã€æ ¸å¿ƒã€‘ä½¿ç”¨çµ•å°è§’åº¦æ¨¡å¼è¨ˆç®—æ§åˆ¶æŒ‡ä»¤
        final_ctrl = action_raw * 1.0 # action_scale è¨­ç‚º 1.0
        data.ctrl[:] = final_ctrl
        mujoco.mj_step(model, data)

    # çœŸæ­£é–‹å§‹æ”¶é›†æ•¸æ“š
    collection_start_time = data.time
    while data.time - collection_start_time < (duration - warmup_duration):
        base_obs = obs_builder.get_observation(np.zeros(3), policy.last_action)
        _, action_raw = policy.get_action(base_obs)
        recent_actions.append(action_raw.copy())
        
        final_ctrl = action_raw * 1.0
        data.ctrl[:] = final_ctrl
        mujoco.mj_step(model, data)

    if not recent_actions:
        print("âŒ éŒ¯èª¤ï¼šæœªèƒ½æ”¶é›†åˆ°ä»»ä½• action æ•¸æ“šã€‚")
        return None
        
    return np.mean(recent_actions, axis=0)

def reset_to_key(model, data, key_id, perturbation=None):
    """
    æ‰‹å‹•å°‡æ¨¡æ“¬é‡ç½®åˆ°æŒ‡å®šçš„ keyframeï¼Œä¸¦å¯é¸æ“‡æ€§åœ°æ–½åŠ æ“¾å‹•ã€‚
    """
    mujoco.mj_resetData(model, data)
    qpos = model.key_qpos[key_id].copy()
    if perturbation is not None:
        qpos[7:] += perturbation
    data.qpos[:] = qpos
    data.qvel[:] = model.key_qvel[key_id]
    mujoco.mj_forward(model, data)


def verify():
    """åŸ·è¡Œé©—è­‰çš„ä¸»å‡½å¼ã€‚"""
    print("=" * 60)
    print("ğŸ¤– æ¨¡å‹è¼¸å‡ºæ¨¡å¼é©—è­‰å·¥å…· (çµ•å°è§’åº¦æ¨¡å¼é©—è­‰ç‰ˆ) ğŸ¤–")
    print("=" * 60)

    try:
        print("1. è¼‰å…¥è¨­å®šèˆ‡æ¨¡å‹...")
        config = load_config()
        if not Path(config.mujoco_model_file).exists():
            print(f"âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ¨¡å‹æª”æ¡ˆ '{config.mujoco_model_file}'")
            return

        model = mujoco.MjModel.from_xml_path(config.mujoco_model_file)
        data = mujoco.MjData(model)
        
        home_key_id = mujoco.mj_name2id(model, mujoco.mjtObj.mjOBJ_KEY, 'home')
        if home_key_id == -1:
            print("âŒ éŒ¯èª¤ï¼šåœ¨ XML ä¸­æ‰¾ä¸åˆ°åç‚º 'home' çš„ keyframeã€‚")
            return
        
        default_pose_from_key = model.key_qpos[home_key_id][7:].copy()
        
        # ç¢ºä¿ä½¿ç”¨èˆ‡æ¨¡å‹åŒ¹é…çš„è§€å¯Ÿé…æ–¹ (å‡è¨­ç‚º48ç¶­)
        obs_dim = 48
        if obs_dim not in config.observation_recipes:
            print(f"âŒ éŒ¯èª¤: config.yaml ä¸­ç¼ºå°‘ç¶­åº¦ç‚º {obs_dim} çš„ observation_recipesã€‚")
            return
        recipe = config.observation_recipes[obs_dim]
             
        # ã€æ ¸å¿ƒã€‘æˆ‘å€‘åœ¨é€™è£¡å¯¦ä¾‹åŒ–çš„ obs_builder æœƒä½¿ç”¨æ‚¨ä¿®æ”¹å¾Œçš„ absolute mode ç‰ˆæœ¬
        obs_builder = ObservationBuilder(recipe, data, model, mujoco.mj_name2id(model, mujoco.mjtObj.mjOBJ_BODY, 'torso'), default_pose_from_key, config)
        base_obs_dim = len(obs_builder.get_observation(np.zeros(3), np.zeros(config.num_motors)))
        
        policy_config = config
        policy_config.initial_tuning_params.action_scale = 1.0 # æ¸¬è©¦æ™‚å›ºå®šç‚º1.0
        policy = ONNXPolicy(policy_config, base_obs_dim)
        print("âœ… è³‡æºè¼‰å…¥æˆåŠŸï¼")
        print("-" * 60)

        # --- å¯¦é©—ä¸€ï¼šåŸºæº–æ¸¬è©¦ (Baseline Test) ---
        print("2. åŸ·è¡Œã€å¯¦é©—ä¸€ï¼šåŸºæº–æ¸¬è©¦ã€‘")
        print("   - å¾æ¨™æº–çš„ 'home' å§¿æ…‹é–‹å§‹ã€‚")
        
        reset_to_key(model, data, home_key_id)
        policy.reset()
        
        stable_action_base = run_simulation(model, data, policy, obs_builder, SIMULATION_DURATION)
        if stable_action_base is None: return

        hip_action_base = np.mean(stable_action_base[HIP_JOINT_INDICES])
        print(f"   ğŸ“Š åŸºæº–ç©©å®šå¾Œ Raw Action (é«–é—œç¯€å¹³å‡å€¼): {hip_action_base:.4f}")
        print("-" * 60)
        time.sleep(1)

        # --- å¯¦é©—äºŒï¼šæ“¾å‹•åˆå§‹å§¿æ…‹æ¸¬è©¦ (Perturbation Test) ---
        print("3. åŸ·è¡Œã€å¯¦é©—äºŒï¼šæ“¾å‹•æ¸¬è©¦ã€‘")
        print(f"   - å¾ä¸€å€‹è¢«æ“¾å‹•éçš„åˆå§‹å§¿æ…‹é–‹å§‹ (é«–é—œç¯€å¢åŠ  {PERTURBATION_VALUE})ã€‚")
        
        perturbation_vector = np.zeros(12)
        perturbation_vector[HIP_JOINT_INDICES] = PERTURBATION_VALUE
        reset_to_key(model, data, home_key_id, perturbation=perturbation_vector)
        policy.reset()

        stable_action_perturbed = run_simulation(model, data, policy, obs_builder, SIMULATION_DURATION)
        if stable_action_perturbed is None: return
        
        hip_action_perturbed = np.mean(stable_action_perturbed[HIP_JOINT_INDICES])
        print(f"   ğŸ“Š æ“¾å‹•ç©©å®šå¾Œ Raw Action (é«–é—œç¯€å¹³å‡å€¼): {hip_action_perturbed:.4f}")
        print("-" * 60)

        # --- 4. åˆ†æèˆ‡çµè«– ---
        print("4. åˆ†æçµæœèˆ‡çµè«–...")
        
        # åœ¨çµ•å°è§’åº¦æ¨¡å¼ä¸‹ï¼Œå…©å€‹å¯¦é©—çš„è¼¸å‡ºæ‡‰è©²å¹¾ä¹ç›¸åŒ
        diff = abs(hip_action_perturbed - hip_action_base)
        print(f"   - å…©å€‹å¯¦é©—çš„ Raw Action ç©©å®šå€¼ä¹‹å·®: {diff:.4f}")
        print("-" * 60)

        if diff < STABILITY_THRESHOLD:
            print("âœ… ã€çµè«–ã€‘é©—è­‰æˆåŠŸï¼æ¨¡å‹çš„è¡Œç‚ºèˆ‡ã€çµ•å°è§’åº¦æ¨¡å¼ (Absolute-based)ã€‘çš„é æœŸç›¸ç¬¦ã€‚")
            print("   ç„¡è«–å¾å“ªå€‹åˆå§‹å§¿æ…‹é–‹å§‹ï¼Œæ¨¡å‹éƒ½èƒ½æ”¶æ–‚åˆ°å¹¾ä¹ç›¸åŒçš„ç›®æ¨™è§’åº¦è¼¸å‡ºã€‚")
            print("   æ‚¨åœ¨ main.py å’Œ observation.py ä¸­çš„çµ•å°è§’åº¦æ¨¡å¼ä¿®æ”¹æ˜¯ã€æ­£ç¢ºçš„ã€‘ã€‚")
        else:
            print("âŒ ã€çµè«–ã€‘é©—è­‰å¤±æ•—ï¼æ¨¡å‹çš„è¡Œç‚ºèˆ‡ã€çµ•å°è§’åº¦æ¨¡å¼ã€‘çš„é æœŸä¸ç¬¦ã€‚")
            print("   æ¨¡å‹çš„è¼¸å‡ºæœƒå› ç‚ºåˆå§‹å§¿æ…‹çš„ä¸åŒè€Œç”¢ç”Ÿå·¨å¤§å·®ç•°ï¼Œé€™ä¸ç¬¦åˆçµ•å°è§’åº¦æ¨¡å‹çš„ç‰¹å¾µã€‚")
            print("   é€™å¯èƒ½æ„å‘³è‘—æ¨¡å‹å¯¦éš›ä¸Šæ˜¯ã€Œåç§»é‡æ¨¡å¼ã€ï¼Œæˆ–è€…æ¨¡å‹æœ¬èº«ä¸å¤ ç©©å®šã€‚")
            print("   å»ºè­°èˆ‡æ¨¡å‹ä½œè€…ç¢ºèªè¨“ç·´æ™‚çš„è§€å¯Ÿç©ºé–“å’Œå‹•ä½œç©ºé–“å®šç¾©ã€‚")
        
        print("=" * 60)

    except Exception as e:
        print(f"\nâŒ é©—è­‰éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    verify()

------------------------------------------------
---  END OF FILE: test/verify_model_mode.py  ---
================================================================================

